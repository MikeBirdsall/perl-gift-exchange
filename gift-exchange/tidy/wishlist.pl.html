<!-- Generated by perltidy on Mon Jan 20 23:45:32 2003 -->
    <HTML> 
	<HEAD> 
	    <TITLE>wishlist.pl - cgi-bin program for managing lists of gifts

</TITLE> 
	</HEAD>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #FFFFFF;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
	<BODY>
<a name="-top-"></a>
<h1>wishlist.pl</h1>

<!-- INDEX BEGIN -->

<UL>

	<LI><A HREF="#NAME">NAME</A>
	<LI><A HREF="#VERSION">VERSION</A>
	<LI><A HREF="#SYNOPSIS">SYNOPSIS</A>
	<LI><A HREF="#DESCRIPTION">DESCRIPTION</A>
	<UL>

		<LI><A HREF="#Overview">Overview</A>
		<LI><A HREF="#Input_parameters">Input parameters</A>
		<LI><A HREF="#Web_Page_State_Diagram_">Web Page State Diagram:</A>
	</UL>

	<LI><A HREF="#ENVIRONMENT">ENVIRONMENT</A>
	<LI><A HREF="#DIAGNOSTICS">DIAGNOSTICS</A>
	<LI><A HREF="#BUGS">BUGS</A>
	<LI><A HREF="#CHANGES_FROM_PREVIOUS_VERSIONS">CHANGES FROM PREVIOUS VERSIONS</A>
	<LI><A HREF="#REFACTORINGS">REFACTORINGS</A>
	<LI><A HREF="#SUGGESTED_ENHANCEMENTS">SUGGESTED ENHANCEMENTS</A>
	<LI><A HREF="#FILES">FILES</A>
	<LI><A HREF="#SEE_ALSO">SEE ALSO</A>
	<LI><A HREF="#AUTHOR">AUTHOR</A>
	<LI><A HREF="#COPYRIGHT">COPYRIGHT</A>
</UL>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#paint_style_menu-">package main</a>
<ul>
<li><a href="#paint_style_menu-">paint_style_menu</a></li>
<li><a href="#stylefile-">stylefile</a></li>
<li><a href="#remove_tabs-">remove_tabs</a></li>
<li><a href="#display_name-">display_name</a></li>
<li><a href="#delete_item-">delete_item</a></li>
<li><a href="#ppf_help_message-">ppf_help_message</a></li>
<li><a href="#prf_help_message-">prf_help_message</a></li>
<li><a href="#paint_footer-">paint_footer</a></li>
<li><a href="#descrip_menu-">descrip_menu</a></li>
<li><a href="#paint_purchase_or_release_form-">paint_purchase_or_release_form</a></li>
<li><a href="#paint_purchase_form-">paint_purchase_form</a></li>
<li><a href="#confirm_purch_or_rel-">confirm_purch_or_rel</a></li>
<li><a href="#validate_expiration-">validate_expiration</a></li>
<li><a href="#submit_edit_or_suggestion-">submit_edit_or_suggestion</a></li>
<li><a href="#paint_item_change_form-">paint_item_change_form</a></li>
<li><a href="#quant_menu-">quant_menu</a></li>
<li><a href="#expires_menu-">expires_menu</a></li>
<li><a href="#paint_suggestion_form-">paint_suggestion_form</a></li>
<li><a href="#error_page-">error_page</a></li>
<li><a href="#print_warning-">print_warning</a></li>
<li><a href="#paint_suggestion_confirmation-">paint_suggestion_confirmation</a></li>
<li><a href="#check_missing-">check_missing</a></li>
<li><a href="#push_user_item-">push_user_item</a></li>
<li><a href="#push_owner_item-">push_owner_item</a></li>
<li><a href="#paint_wishlist-">paint_wishlist</a></li>
<li><a href="#paint_owner_choice_form-">paint_owner_choice_form</a></li>
<li><a href="#attributes_for-">attributes_for</a></li>
</ul>
</li>
<li><a href="#__END__-">__END__</a></li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<HR>

<P>
<HR>
<H1><A NAME="NAME">NAME

</A></H1>
wishlist.pl - cgi-bin program for managing lists of gifts


<P>

<P>
<HR>
<H1><A NAME="VERSION">VERSION

</A></H1>
This document refers to version 0.80 of wishlist, released Jan 1, 2003.


<P>

<P>
<HR>
<H1><A NAME="SYNOPSIS">SYNOPSIS

</A></H1>
<PRE> wishlist [action=Pick A[n Owner]] [debug=&lt;level&gt;] [style=&lt;which&gt;]
</PRE>

<P>

<PRE> wishlist [debug=&lt;level&gt;] [style=&lt;fname&gt;] owner=&lt;owner&gt; 
    action=[Delete|Buy|Release|Edit] &lt;itemnum&gt;
</PRE>

<P>

<PRE> wishlist [debug=&lt;level&gt;] [style=&lt;sname&gt;] owner=&lt;owner&gt; 
    action=[Confirm [Purchase|Release|Entry]|Submit Suggestion]
    description=&lt;text&gt; wanted=&lt;number&gt;
</PRE>

<P>

<PRE> wishlist [debug=&lt;level&gt;] [style=&lt;sname&gt;] owner=&lt;owner&gt; 
    action=[Confirm Entry|Submit Suggestion]
    description=&lt;text&gt; wanted=&lt;number&gt;
    expires_type=[Never|Christmas|In A Year]
</PRE>

<P>

<PRE> wishlist [debug=&lt;level&gt;] [style=&lt;sname&gt;] owner=&lt;owner&gt; 
    action=[Confirm Entry|Submit Suggestion]
    description=&lt;text&gt; wanted=&lt;number&gt;
    expires_type=Date Selected
    month_expires=[0|1|2|3|4|5|6|7|8|9|10|11]
    day_expires=[1|2|3| ... |29|30|31]
    year_expires=&lt;year&gt;
</PRE>

<P>

<PRE> wishlist [debug=&lt;level&gt;] [style=&lt;sname&gt;] owner=&lt;owner&gt; 
    action=&quot;Submit Edited Item&quot; item=&lt;itemnum&gt; 
    description=&lt;text&gt; wanted=&lt;number&gt;
    expires_type=[Never|Christmas|In A Year]
</PRE>

<P>

<PRE> wishlist [debug=&lt;level&gt;] [style=&lt;sname&gt;] owner=&lt;owner&gt; 
    action=&quot;Submit Edited Item&quot; item=&lt;itemnum&gt; 
    description=&lt;text&gt; wanted=&lt;number&gt;
    expires_type=Date Selected
    month_expires=[0|1|2|3|4|5|6|7|8|9|10|11]
    day_expires=[1|2|3| ... |29|30|31]
    year_expires=&lt;year&gt;
</PRE>

<P>

<PRE> wishlist [debug=&lt;level&gt;] [style=&lt;sname&gt;] owner=&lt;owner&gt; 
    action=[Change Entry|Add Suggestion]
</PRE>

<P>

<P>
<HR>
<H1><A NAME="DESCRIPTION">DESCRIPTION

</A></H1>
<P>
<HR>
<H2><A NAME="Overview">Overview

</A></H2>
Creates HTML pages for wishlist maintenance. 


<P>

The following actions modify the wishlist file: Delete Confirm Purchase
Confirm Release Submit Edited Item Confirm Entry


<P>

<P>
<HR>
<H2><A NAME="Input_parameters">Input parameters

</A></H2>
<PRE> owner
 action
 description
 wanted
 debug
 style
 lastaction
 item
</PRE>

<P>

<P>
<HR>
<H2><A NAME="Web_Page_State_Diagram_">Web Page State Diagram:

</A></H2>
<PRE> &gt;---------------------------------------------&gt;Delete-------------------&gt;|
 |--&gt;Buy Item---------------------------------&gt;{Confirm Purchase}--------&gt;|
 |--&gt;Release Item-----------------------------&gt;{Confirm Release }--------&gt;|
 |--&gt;Edit-----------------------------------|                             |
 |--&gt;Add Suggestion-|                       '-&gt;{Submit Edited Item}------&gt;|
 |                  |--&gt;Submit Suggestion-----&gt;{Confirm Entry     }------&gt;|
 |--&gt;Change Entry---|                     |                               |
 | ^                                      |                               |
 | '--------------------------------------'                               |
 |                                                                        v
 '------------------------------------------------------------------------'
____________________________________________________________________________
</PRE>

<P>

<PRE> &gt;---------------------------------------------&gt;delete_item()------------&gt;|
 |--&gt;paint_purchase_form()---|                                            |
 |                           |-----------------&gt;confirm_purch_or_rel()---&gt;|
 |--&gt;paint_purchase_form()---|                                            |
 |--&gt;paint_item_change_form()-----------|                                 |
 |--&gt;paint_suggestion_form()-|          |--&gt;submit_edit_or_suggestion()--&gt;|
 |                           |--&gt;psc*---|                                 |
 |--&gt;paint_suggestion_form()-|        |                                   |
 | ^                                  |                                   |
 | |----------------------------------'                                   |
 |                     psc* =&gt; paint_suggestion_confirmation              v
 '------------------------------------------------------------------------'
</PRE>

<P>

<P>
<HR>
<H1><A NAME="ENVIRONMENT">ENVIRONMENT

</A></H1>
REMOTE_USER - the login ID of the individual running the program.


<P>

<P>
<HR>
<H1><A NAME="DIAGNOSTICS">DIAGNOSTICS

</A></H1>
<DL>
<DT><STRONG><A NAME="item__You">"You are not properly logged in"

</A></STRONG><DD>
This message will be printed on the page when we cannot detect the remote
user environment form. That means that either the web site was not set up
with security, so the user is not logged in and is unidentified, or that
the program is being run interactively without the REMOTE_USER environment
variable set.


<P>

<DT><STRONG><A NAME="item__Repository">"Repository <dirname> does not exist."

</A></STRONG><DD>
The repository for all of the data-files is expected in directory
&lt;dirname&gt; and the program cannot locate that directory.


<P>

</DL>
<P>
<HR>
<H1><A NAME="BUGS">BUGS

</A></H1>
<OL>
<LI><STRONG><A NAME="item_Jan2003_Suggestion_does_not_show">Jan2003 Suggestion does not show up the first time

</A></STRONG>
When you first create a suggestion and run it through
submit_edit_or_suggestion, it doesn't show up on the screen. When you
refresh the screen, it shows up. Ed noted this on his 19Jan2003 email, as
well.


<P>

<DT><STRONG><A NAME="item_Expiration">Expiration date inconsistencies

</A></STRONG><DD>
Shows obsolete items to the list owner. Doesn't default an expiration date.
Named dates (like Christmas) are not implemented.


<P>

</OL>
<P>
<HR>
<H1><A NAME="CHANGES_FROM_PREVIOUS_VERSIONS">CHANGES FROM PREVIOUS VERSIONS

</A></H1>
<DL>
<DT><STRONG>Expiration date

</A></STRONG><DD>
Allow a suggester (particularly the owner) to put an expiration date on the
item, after which time he is free to buy it himself.


<P>

<DT><STRONG><A NAME="item_Edit">Edit or Undo Purchases

</A></STRONG><DD>
Allow a purchaser to renege on a purchase - putting it back in the list as
available - and to add to their note.


<P>

</DL>
<P>
<HR>
<H1><A NAME="REFACTORINGS">REFACTORINGS

</A></H1>
<P>
<HR>
<H1><A NAME="SUGGESTED_ENHANCEMENTS">SUGGESTED ENHANCEMENTS

</A></H1>
<DL>
<DT><STRONG><A NAME="item_Mark">Mark gifts as Received

</A></STRONG><DD>
Allow the giver or perhaps the recipient of a gift to mark it as received
and thus no longer on the list.


<P>

<DT><STRONG><A NAME="item_Retrieving">Retrieving password

</A></STRONG><DD>
Send lost passwords out the stored e-mail address.


<P>

<DT><STRONG><A NAME="item_Personal">Personal Control Panel

</A></STRONG><DD>
Create a Control Panel for each user where the user can change such things
as


<P>

<PRE>    Screen color preferences
    Full Name
    email address
    Password
    Clothing Sizes
    Defaults
        expiration date
    Occasions
        Birthdays, Holidays, Anniversaries, ...
    Watch List
        People to be notified about
</PRE>

<P>

<DT><STRONG><A NAME="item_Change">Change date-times to UTC

</A></STRONG><DD>
<DT><STRONG><A NAME="item_Help">Help screens

</A></STRONG><DD>
<DT><STRONG><A NAME="item_URLs">URLs in suggestions

</A></STRONG><DD>
<DT><STRONG><A NAME="item_Public">Public Suggestions

</A></STRONG><DD>
Allow suggestions to be marked as visible for owner


<P>

<DT><STRONG><A NAME="item_E">E-Mail Notifications

</A></STRONG><DD>
</DL>
<P>
<HR>
<H1><A NAME="FILES">FILES

</A></H1>
<P>
<HR>
<H1><A NAME="SEE_ALSO">SEE ALSO

</A></H1>
multilist.pl, ibought.pl, Christmas::Wishlist.pm,
Christmas::Wishlist::WishItem.pm 


<P>

<P>
<HR>
<H1><A NAME="AUTHOR">AUTHOR

</A></H1>
Michael G. Birdsall


<P>

<P>
<HR>
<H1><A NAME="COPYRIGHT">COPYRIGHT

</A></H1>
Copyright (c) 2002,2003, Michael G. Birdsall. All Rights Reserved. This
module is free software. It may be used, redistributed and/or modified
under the same terms as Perl itself.


<P>

</DL>
<hr /><pre>#!/usr/local/bin/perl
<span class="c"># $Id: wishlist.pl,v 1.46 2003/01/21 04:43:42 mbirdsal Exp $</span>
<span class="c"># $Name:  $</span>

<span class="c"># This CGI-BIN perl script is the standard user script for Wish lists.</span>
<span class="c"># It has been modified to use the Wishlist.pm objects, and should only manage</span>
<span class="c"># the web access to using those objects.</span>
<span class="c"># A wish list is a list for each person to keep track of gifts they would like</span>
<span class="c"># and gifts that people have bought them.</span>
<span class="c">#</span>
<span class="c"># Uses Wishlist objects and WishItem objects to manipulate and interrogate</span>
<span class="c"># a wishlist (which is actually stored as file of all transactions).</span>
<span class="c">#</span>
<span class="c"># The following two lines are useful to cut and paste for debugging purposes.</span>
<span class="c">#if ($debug) {print h2({-class=&gt;'Debug'},</span>
<span class="c">#                   &quot;Line &quot;,__LINE__,&quot; module &quot;,(caller(0))[3])}</span>

<span class="k">use</span> <span class="w">lib</span> <span class="q">'/big/dom/xkirkbird/lib/perl5/site_perl/5.005/'</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">CGI</span> <span class="q">':standard'</span><span class="cm">,</span> <span class="q">':html3'</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">CGI::Carp</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">CGI</span> <span class="q">qw/escapeHTML unescapeHTML/</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">POSIX</span> <span class="q">'strftime'</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Time::Local</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Fcntl</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Christmas::Wishlist</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$debug</span> = <span class="i">param</span><span class="s">(</span><span class="q">'debug'</span><span class="s">)</span><span class="sc">;</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c"># Closure for style definitions - these all manipulate styles</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$style_prefix</span> = <span class="q">&quot;/css/wls_&quot;</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="c"># paint_style_menu</span>
    <span class="c">#     prints the html for the menu to choose styles</span>
<a name="paint_style_menu-"></a>    <span class="k">sub </span><span class="m">paint_style_menu</span>
    <span class="s">{</span>

        <span class="k">print</span> <span class="i">br</span><span class="cm">,</span> <span class="i">p</span><span class="s">(</span><span class="q">&quot;Choose style for pages&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">popup_menu</span><span class="s">(</span>
            -<span class="w">name</span>   <span class="cm">=&gt;</span> <span class="q">'style'</span><span class="cm">,</span>
            -<span class="w">values</span> <span class="cm">=&gt;</span> <span class="s">[</span>
                <span class="q">&quot;&quot;</span><span class="cm">,</span>
                <span class="k">map</span> <span class="s">{</span> <span class="q">m[\.\.${style_prefix}(\w+)\.css]</span> <span class="s">}</span>
                  <span class="k">glob</span><span class="s">(</span><span class="q">&quot;..${style_prefix}*.css&quot;</span><span class="s">)</span>
            <span class="s">]</span><span class="cm">,</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#</span>
    <span class="c"># stylefile</span>
    <span class="c">#     Returns a string containing the file with the css style for the style</span>
    <span class="c">#     parameter chosen</span>
<a name="stylefile-"></a>    <span class="k">sub </span><span class="m">stylefile</span>
    <span class="s">{</span>
        <span class="k">return</span> <span class="i">$style_prefix</span> . <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">'style'</span><span class="s">)</span> || <span class="q">'default'</span> <span class="s">)</span> . <span class="q">'.css'</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c"># Set the initial data</span>
<span class="c"># The following two variables, $gltitle and $glrepository, are actually used as</span>
<span class="c"># global variables. They are the only two in this program. Consider getting rid</span>
<span class="c"># of them, and maybe making a closure to get rid of all globals.</span>

<span class="k">my</span> <span class="i">$glrepository</span> =
  <span class="s">(</span> <span class="i">$ENV</span>{<span class="w">HOME</span>} || <span class="i">$ENV</span>{<span class="w">LOGDIR</span>} || <span class="s">(</span> <span class="k">getpwuid</span><span class="s">(</span><span class="i">$&gt;</span><span class="s">)</span> <span class="s">)</span>[<span class="n">7</span>] <span class="s">)</span>
  . <span class="q">&quot;/wishlistdata/family/&quot;</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$gluser</span> = <span class="i">remote_user</span><span class="s">(</span><span class="s">)</span>
  || <span class="i">error_page</span><span class="s">(</span><span class="q">&quot;You are not properly logged in.&quot;</span><span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$gltitle</span> = <span class="q">'Hello '</span>
  . <span class="i">display_name</span><span class="s">(</span><span class="i">$gluser</span><span class="s">)</span>
  . <span class="q">'! You Are On the Page To Change or Display Wish Lists'</span><span class="sc">;</span>

<span class="w">Christmas::Wishlist</span><span class="i">-&gt;set_repository</span><span class="s">(</span><span class="i">$glrepository</span><span class="s">)</span>
  <span class="k">or</span> <span class="i">error_page</span><span class="s">(</span><span class="q">&quot;Repository $glrepository does not exist.&quot;</span><span class="s">)</span><span class="sc">;</span>

<span class="k">print</span> <span class="i">header</span><span class="cm">,</span>
  <span class="i">start_html</span><span class="s">(</span>
    -<span class="w">title</span> <span class="cm">=&gt;</span> <span class="i">$gltitle</span><span class="cm">,</span>
    -<span class="w">style</span> <span class="cm">=&gt;</span> <span class="s">{</span> -<span class="w">src</span> <span class="cm">=&gt;</span> <span class="i">stylefile</span><span class="s">(</span><span class="s">)</span> <span class="s">}</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="i">h2</span><span class="s">(</span> <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Debug'</span> <span class="s">}</span><span class="cm">,</span> <span class="q">&quot;Repository at $glrepository&quot;</span> <span class="s">)</span> <span class="s">}</span>

<span class="c"># paint_owner_choice_form does not return, but re-enters with param('owner') set</span>
<span class="k">my</span> <span class="i">$glowner</span> = <span class="i">param</span><span class="s">(</span><span class="q">'owner'</span><span class="s">)</span> || <span class="i">paint_owner_choice_form</span><span class="s">(</span><span class="i">$gluser</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># Now that we have an owner; get the wishlist for that owner</span>
<span class="k">my</span> <span class="i">$glwishlist</span> = <span class="w">Christmas::Wishlist</span><span class="i">-&gt;new</span><span class="s">(</span> <span class="w">userid</span> <span class="cm">=&gt;</span> <span class="i">$glowner</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c"># Do the specific actions for this invocation</span>

<span class="i">$_</span> = <span class="i">param</span><span class="s">(</span><span class="q">'action'</span><span class="s">)</span> || <span class="i">param</span><span class="s">(</span><span class="q">'lastaction'</span><span class="s">)</span><span class="sc">;</span>

<span class="j">CASE:</span> <span class="s">{</span>

    <span class="c"># Commands Issued from the Wishlist</span>

    <span class="q">/^Delete/i</span> <span class="k">and</span> <span class="k">do</span> <span class="s">{</span>
        <span class="i">delete_item</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span><span class="cm">,</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">paint_wishlist</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">last</span> <span class="j">CASE</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="q">/^Buy Item/i</span> <span class="k">and</span> <span class="k">do</span> <span class="s">{</span>
        <span class="i">paint_purchase_form</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span><span class="cm">,</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">last</span> <span class="j">CASE</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="q">/^Release Item/i</span> <span class="k">and</span> <span class="k">do</span> <span class="s">{</span>
        <span class="i">paint_purchase_form</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span><span class="cm">,</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">last</span> <span class="j">CASE</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="q">/^Edit /i</span> <span class="k">and</span> <span class="k">do</span> <span class="s">{</span>
        <span class="i">paint_item_change_form</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span><span class="cm">,</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">paint_wishlist</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">last</span> <span class="j">CASE</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="q">/^(Change Entry|Add Suggestion)/i</span> <span class="k">and</span> <span class="k">do</span> <span class="s">{</span>
        <span class="i">paint_suggestion_form</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">last</span> <span class="j">CASE</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="c"># #   Other Commands</span>

    <span class="q">/^Confirm (Purchase|Release)/i</span> <span class="k">and</span> <span class="k">do</span> <span class="s">{</span>
        <span class="i">confirm_purch_or_rel</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span><span class="cm">,</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">paint_wishlist</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">last</span> <span class="j">CASE</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="q">/^Submit Edited Item/i</span> <span class="k">and</span> <span class="k">do</span> <span class="s">{</span>
        <span class="i">submit_edit_or_suggestion</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span><span class="cm">,</span> <span class="i">param</span><span class="s">(</span><span class="q">'item'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">paint_wishlist</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">last</span> <span class="j">CASE</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="q">/^Submit Suggestion/i</span> <span class="k">and</span> <span class="k">do</span> <span class="s">{</span>
        <span class="i">paint_suggestion_confirmation</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">last</span> <span class="j">CASE</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="q">/^Confirm Entry/i</span> <span class="k">and</span> <span class="k">do</span> <span class="s">{</span>
        <span class="i">submit_edit_or_suggestion</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">paint_wishlist</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">last</span> <span class="j">CASE</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="q">/^Pick A/i</span> <span class="k">and</span> <span class="k">do</span> <span class="s">{</span>
        <span class="i">paint_owner_choice_form</span><span class="s">(</span><span class="i">$gluser</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">last</span> <span class="j">CASE</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="c"># default</span>
    <span class="i">paint_wishlist</span><span class="s">(</span> <span class="i">$glwishlist</span><span class="cm">,</span> <span class="i">$gluser</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>
<span class="i">paint_style_menu</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">print</span> <span class="i">end_form</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">print</span> <span class="i">end_html</span><span class="sc">;</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># remove_tabs</span>
<a name="remove_tabs-"></a><span class="k">sub </span><span class="m">remove_tabs</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$description</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="i">$description</span> =~ <span class="q">tr/\t/ /</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$description</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># display_name</span>
<span class="c">#     returns the display name given the login-id</span>
<a name="display_name-"></a><span class="k">sub </span><span class="m">display_name</span>
<span class="s">{</span>

    <span class="k">return</span> <span class="i">attributes_for</span><span class="s">(</span> <span class="i">$_</span>[<span class="n">0</span>]<span class="cm">,</span> <span class="q">'name'</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># delete_item runs as an &quot;action&quot; command.</span>
<span class="c"># It deletes the designated item.</span>
<span class="c"># Only the owner should be allowed to delete it.</span>

<a name="delete_item-"></a><span class="k">sub </span><span class="m">delete_item</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$which</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$itemnum</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$itemnum</span> = <span class="i">$which</span> <span class="s">)</span> =~ <span class="q">s/Delete //</span><span class="sc">;</span>

    <span class="i">$wishlist</span><span class="i">-&gt;remove</span><span class="s">(</span> <span class="w">itemnum</span> <span class="cm">=&gt;</span> <span class="i">$itemnum</span><span class="cm">,</span> <span class="w">by</span> <span class="cm">=&gt;</span> <span class="i">$user</span><span class="cm">,</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># ppf_help_message</span>
<a name="ppf_help_message-"></a><span class="k">sub </span><span class="m">ppf_help_message</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$which</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">p</span><span class="s">(</span>
        <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Help'</span> <span class="s">}</span><span class="cm">,</span>
        <span class="i">display_name</span><span class="s">(</span><span class="i">$user</span><span class="s">)</span><span class="cm">,</span>
        <span class="q">&quot;this form lets you tell the world that you will be buying -&quot;</span><span class="cm">,</span>
        <span class="i">escapeHTML</span><span class="s">(</span> <span class="i">$wishlist</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$which</span><span class="s">)</span><span class="i">-&gt;description</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="cm">,</span>
        <span class="q">&quot; - for &quot;</span><span class="cm">,</span>
        <span class="i">display_name</span><span class="s">(</span> <span class="i">$wishlist</span><span class="i">-&gt;userid</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="cm">,</span>
      <span class="s">)</span><span class="cm">,</span>
      <span class="i">p</span><span class="s">(</span> <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Help'</span> <span class="s">}</span><span class="cm">,</span>
        <span class="q">&quot;Please help out by giving me a little more information.&quot;</span> <span class="s">)</span><span class="cm">,</span>
      <span class="i">p</span><span class="s">(</span>
        <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Help'</span> <span class="s">}</span><span class="cm">,</span>
        <span class="q">&quot;Note: is where you put in a little information &quot;</span><span class="cm">,</span>
        <span class="q">&quot;for yourself or others about this purchase. If &quot;</span><span class="cm">,</span>
        <span class="q">&quot;you are buying a CD from several asked for, &quot;</span><span class="cm">,</span>
        <span class="q">&quot;you could list which CD you found. If you are &quot;</span><span class="cm">,</span>
        <span class="q">&quot;willing to let others go in on it with you, &quot;</span><span class="cm">,</span>
        <span class="q">&quot;you could say so.&quot;</span>
      <span class="s">)</span><span class="cm">,</span>
      <span class="i">p</span><span class="s">(</span>
        <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Help'</span> <span class="s">}</span><span class="cm">,</span>
        <span class="q">&quot;How many are you buying? lets you choose how many &quot;</span><span class="cm">,</span>
        <span class="q">&quot;(of those still wanted) you are going to buy.&quot;</span>
      <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># Prints a help message on the &quot;Release Form&quot; to help a user fill it in.</span>
<span class="c"># prf_help_message</span>
<a name="prf_help_message-"></a><span class="k">sub </span><span class="m">prf_help_message</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$which</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">p</span><span class="s">(</span>
        <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Help'</span> <span class="s">}</span><span class="cm">,</span>
        <span class="i">display_name</span><span class="s">(</span><span class="i">$user</span><span class="s">)</span><span class="cm">,</span>
        <span class="q">&quot;You indicated that you would be buying&quot;</span><span class="cm">,</span>
        <span class="i">escapeHTML</span><span class="s">(</span> <span class="i">$wishlist</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$which</span><span class="s">)</span><span class="i">-&gt;description</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="cm">,</span>
        <span class="q">&quot; - for &quot;</span><span class="cm">,</span>
        <span class="i">display_name</span><span class="s">(</span> <span class="i">$wishlist</span><span class="i">-&gt;userid</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="cm">,</span>
      <span class="s">)</span><span class="cm">,</span>
      <span class="i">p</span><span class="s">(</span>
        <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Help'</span> <span class="s">}</span><span class="cm">,</span>
        <span class="q">&quot;This form lets you reverse that process, perhaps because &quot;</span><span class="cm">,</span>
        <span class="q">&quot;you could not buy it, perhaps because you got something else.&quot;</span>
      <span class="s">)</span><span class="cm">,</span>
      <span class="i">p</span><span class="s">(</span>
        <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Help'</span> <span class="s">}</span><span class="cm">,</span>
        <span class="q">&quot;Note: Add some information. If you had put in some information &quot;</span><span class="cm">,</span>
        <span class="q">&quot;on the Note: field when you reserved it, you can tell everyone &quot;</span><span class="cm">,</span>
        <span class="q">&quot;if that is no longer true.&quot;</span><span class="cm">,</span>
      <span class="s">)</span><span class="cm">,</span>
      <span class="i">p</span><span class="s">(</span>
        <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Help'</span> <span class="s">}</span><span class="cm">,</span>
        <span class="q">&quot;How many are you releasing? lets you indicate how many &quot;</span><span class="cm">,</span>
        <span class="q">&quot;(of those you reserved) you are not going to buy.&quot;</span>
      <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># paint_footer</span>
<span class="c">#    paints a set of submits (normally) at the bottom of the screen</span>
<span class="c">#    which does the standard control for a screen</span>
<a name="paint_footer-"></a><span class="k">sub </span><span class="m">paint_footer</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$command</span><span class="cm">,</span> <span class="i">@command</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">print</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'lastaction'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$command</span><span class="cm">,</span> -<span class="w">override</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span>
      <span class="k">if</span> <span class="k">defined</span> <span class="i">$command</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="i">$command</span> <span class="s">(</span><span class="i">@command</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'action'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$command</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">print</span> <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'dummy'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'Redraw the screen'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">button</span><span class="s">(</span>
        -<span class="w">value</span>   <span class="cm">=&gt;</span> <span class="q">&quot;Family Page&quot;</span><span class="cm">,</span>
        -<span class="w">onClick</span> <span class="cm">=&gt;</span> <span class="q">&quot;window.location='index.html'&quot;</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">button</span><span class="s">(</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">&quot;Print Page&quot;</span><span class="cm">,</span> -<span class="w">onClick</span> <span class="cm">=&gt;</span> <span class="q">&quot;window.print()&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># descrip_menu</span>
<span class="c"># Returns the Gift Description form segment for a number of pages</span>
<a name="descrip_menu-"></a><span class="k">sub </span><span class="m">descrip_menu</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$header</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">TR</span><span class="s">(</span> <span class="s">{</span> -<span class="w">align</span> <span class="cm">=&gt;</span> <span class="q">&quot;LEFT&quot;</span> <span class="s">}</span><span class="cm">,</span>
        <span class="i">th</span><span class="s">(</span><span class="q">'Note'</span><span class="s">)</span><span class="cm">,</span> <span class="i">td</span><span class="s">(</span> <span class="i">textfield</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'description'</span><span class="cm">,</span> -<span class="w">size</span> <span class="cm">=&gt;</span> <span class="n">90</span> <span class="s">)</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># paint_purchase_or_release_form</span>
<span class="c"># Paints the screen in the way those two actions need.</span>
<a name="paint_purchase_or_release_form-"></a><span class="k">sub </span><span class="m">paint_purchase_or_release_form</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$header</span><span class="cm">,</span> <span class="i">$prompt</span><span class="cm">,</span> <span class="i">$values</span><span class="cm">,</span> <span class="i">$default</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">print</span> <span class="i">h1</span><span class="s">(</span> <span class="i">$header</span><span class="cm">,</span> <span class="i">display_name</span><span class="s">(</span> <span class="i">$wishlist</span><span class="i">-&gt;userid</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">start_form</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span>
      <span class="i">table</span><span class="s">(</span>
        <span class="i">descrip_menu</span><span class="s">(</span><span class="q">'Note'</span><span class="s">)</span><span class="cm">,</span>
        <span class="i">quant_menu</span><span class="s">(</span>
            <span class="w">prompt</span>  <span class="cm">=&gt;</span> <span class="i">$prompt</span><span class="cm">,</span>
            <span class="w">values</span>  <span class="cm">=&gt;</span> <span class="i">$values</span><span class="cm">,</span>
            <span class="w">default</span> <span class="cm">=&gt;</span> <span class="i">$default</span><span class="cm">,</span>
        <span class="s">)</span><span class="cm">,</span>
      <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># paint_purchase_form runs as an  &quot;action&quot; command.</span>
<span class="c"># It creates the page which gets all the information for a purchase</span>
<span class="c">#</span>
<span class="c"># Make the wanted selection work</span>
<span class="c"># limited the wanted selection to the number still wanted</span>
<a name="paint_purchase_form-"></a><span class="k">sub </span><span class="m">paint_purchase_form</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$which</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$itemnum</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$itemnum</span> = <span class="i">$which</span> <span class="s">)</span> =~ <span class="q">s/(Buy|Release) Item //</span><span class="sc">;</span>

    <span class="i">paint_purchase_or_release_form</span><span class="s">(</span>
        <span class="i">$wishlist</span><span class="cm">,</span>
        <span class="s">(</span> <span class="i">$which</span> =~ <span class="q">/Buy/</span> <span class="s">)</span>
        ? <span class="q">&quot;Buying or Reserving a Gift for &quot;</span>
        <span class="co">:</span> <span class="q">&quot;Releasing a gift I Reserved for &quot;</span><span class="cm">,</span>
        <span class="s">(</span> <span class="i">$which</span> =~ <span class="q">/Buy/</span> <span class="s">)</span>
        ? <span class="q">&quot;How many are you buying?&quot;</span>
        <span class="co">:</span> <span class="q">&quot;How many are you releasing?&quot;</span><span class="cm">,</span>
        <span class="s">(</span> <span class="i">$which</span> =~ <span class="q">/Buy/</span> <span class="s">)</span>
        ? <span class="s">(</span> <span class="i">$wishlist</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$itemnum</span><span class="s">)</span><span class="i">-&gt;wanted</span><span class="s">(</span><span class="s">)</span> !~ <span class="q">/^[1-9]\d*/</span> <span class="s">)</span>
        ? <span class="s">[</span> <span class="n">1</span> .. <span class="n">9</span> <span class="s">]</span>
        <span class="co">:</span> <span class="s">[</span> <span class="n">1</span> .. <span class="i">$wishlist</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$itemnum</span><span class="s">)</span><span class="i">-&gt;wanted</span><span class="s">(</span><span class="s">)</span> <span class="s">]</span>
        <span class="co">:</span> <span class="s">[</span> <span class="n">1</span> .. <span class="i">$wishlist</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$itemnum</span><span class="s">)</span><span class="i">-&gt;purchased_by</span><span class="s">(</span><span class="i">$user</span><span class="s">)</span> <span class="s">]</span><span class="cm">,</span>
        <span class="s">(</span> <span class="i">$which</span> =~ <span class="q">/Buy/</span> <span class="s">)</span>
        ? <span class="n">1</span>
        <span class="co">:</span> <span class="i">$wishlist</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$itemnum</span><span class="s">)</span><span class="i">-&gt;purchased_by</span><span class="s">(</span><span class="i">$user</span><span class="s">)</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$which</span> =~ <span class="q">/Buy/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">ppf_help_message</span><span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$itemnum</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">prf_help_message</span><span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$itemnum</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">print</span> <span class="i">br</span><span class="cm">,</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'owner'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">paint_footer</span><span class="s">(</span>
        <span class="i">$which</span><span class="cm">,</span>
        <span class="s">(</span> <span class="i">$which</span> =~ <span class="q">/Buy/</span> <span class="s">)</span>
        ? <span class="q">&quot;Confirm Purchase $itemnum&quot;</span>
        <span class="co">:</span> <span class="q">&quot;Confirm Release $itemnum&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Pick Another List&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># confirm_purch_or_rel runs as an  &quot;action&quot; command.</span>
<span class="c"># It marks an instance of this item as being bought by the user</span>
<span class="c">#</span>
<a name="confirm_purch_or_rel-"></a><span class="k">sub </span><span class="m">confirm_purch_or_rel</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$which</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="s">(</span> <span class="k">my</span> <span class="i">$itemnum</span> = <span class="i">$which</span> <span class="s">)</span> =~ <span class="q">s/Confirm\s+(Purchase|Release)\s+//</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$wanted</span> = <span class="i">param</span><span class="s">(</span><span class="q">'wanted'</span><span class="s">)</span> * <span class="s">(</span> <span class="s">(</span> <span class="i">$which</span> =~ <span class="q">/Release/</span> <span class="s">)</span> ? <span class="n">-1</span> <span class="co">:</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$wishlist</span><span class="i">-&gt;purchase</span><span class="s">(</span>
        <span class="w">itemnum</span>     <span class="cm">=&gt;</span> <span class="i">$itemnum</span><span class="cm">,</span>
        <span class="w">description</span> <span class="cm">=&gt;</span> <span class="i">remove_tabs</span><span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">'description'</span><span class="s">)</span> <span class="s">)</span> || <span class="q">''</span><span class="cm">,</span>
        <span class="w">how_many</span>    <span class="cm">=&gt;</span> <span class="i">$wanted</span><span class="cm">,</span>
        <span class="w">by</span>          <span class="cm">=&gt;</span> <span class="i">$user</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># validate_expiration returns a specific type of expiration date, i.e. either:</span>
<span class="c">#     &quot;MMM dd yyyy&quot;  or  &quot;never&quot;  or  &quot;invalid&quot;</span>
<span class="c"># For the moment, it is either the &quot;MMM dd yyyy&quot; form or &quot;never&quot;</span>
<a name="validate_expiration-"></a><span class="k">sub </span><span class="m">validate_expiration</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$x</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$xtype</span> = <span class="i">param</span><span class="s">(</span><span class="q">'expires_type'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="q">&quot;never&quot;</span> <span class="k">if</span> <span class="i">$xtype</span> =~ <span class="q">/never/i</span><span class="sc">;</span>
    <span class="k">return</span> <span class="q">&quot;never&quot;</span> <span class="k">if</span> <span class="i">$xtype</span> =~ <span class="q">/^\s*$/</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$xtype</span> <span class="k">eq</span> <span class="q">'Date Selected'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$x</span> = <span class="k">join</span> <span class="q">&quot; &quot;</span><span class="cm">,</span> <span class="i">param</span><span class="s">(</span><span class="q">'month_expires'</span><span class="s">)</span><span class="cm">,</span> <span class="i">param</span><span class="s">(</span><span class="q">'day_expires'</span><span class="s">)</span><span class="cm">,</span>
          <span class="i">param</span><span class="s">(</span><span class="q">'year_expires'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;never&quot;</span> <span class="k">if</span> <span class="i">$x</span> =~ <span class="q">/^\s*$/</span><span class="sc">;</span>
        <span class="k">return</span> <span class="i">$x</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$xtype</span> <span class="k">eq</span> <span class="q">'Christmas'</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># Compute the date of next Christmas, being careful of Dec 25-Dec 31.</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$DAY</span><span class="cm">,</span> <span class="i">$MONTH</span><span class="cm">,</span> <span class="i">$YEAR</span> <span class="s">)</span> = <span class="s">(</span><span class="k">localtime</span><span class="s">)</span>[ <span class="n">3</span><span class="cm">,</span> <span class="n">4</span><span class="cm">,</span> <span class="n">5</span> ]<span class="sc">;</span>
        <span class="i">$YEAR</span>++ <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$MONTH</span> == <span class="n">11</span> <span class="s">)</span> <span class="k">and</span> <span class="s">(</span> <span class="i">$DAY</span> &gt;= <span class="n">25</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$YEAR</span> += <span class="n">1900</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;Dec 26 $YEAR&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$xtype</span> <span class="k">eq</span> <span class="q">'In A Year'</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># Compute the date of a year from now.</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$DAY</span><span class="cm">,</span> <span class="i">$MONTH</span><span class="cm">,</span> <span class="i">$YEAR</span> <span class="s">)</span> = <span class="s">(</span><span class="k">localtime</span><span class="s">)</span>[ <span class="n">3</span><span class="cm">,</span> <span class="n">4</span><span class="cm">,</span> <span class="n">5</span> ]<span class="sc">;</span>
        <span class="i">$DAY</span> = <span class="n">28</span> <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$MONTH</span> == <span class="n">1</span> <span class="s">)</span> <span class="k">and</span> <span class="s">(</span> <span class="i">$DAY</span> &gt;= <span class="n">29</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$YEAR</span> += <span class="n">1901</span><span class="sc">;</span>
        <span class="i">$MONTH</span> = <span class="s">(</span>
            <span class="q">'Jan'</span><span class="cm">,</span> <span class="q">'Feb'</span><span class="cm">,</span> <span class="q">'Mar'</span><span class="cm">,</span> <span class="q">'Apr'</span><span class="cm">,</span> <span class="q">'May'</span><span class="cm">,</span> <span class="q">'Jun'</span><span class="cm">,</span>
            <span class="q">'Jul'</span><span class="cm">,</span> <span class="q">'Aug'</span><span class="cm">,</span> <span class="q">'Sep'</span><span class="cm">,</span> <span class="q">'Oct'</span><span class="cm">,</span> <span class="q">'Nov'</span><span class="cm">,</span> <span class="q">'Dec'</span><span class="cm">,</span>
        <span class="s">)</span>[<span class="i">$MONTH</span>]<span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;$DAY $MONTH $YEAR&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="q">&quot;The conversion routine from &quot;</span>
      . <span class="i">param</span><span class="s">(</span><span class="q">'expires_type'</span><span class="s">)</span>
      . <span class="q">&quot; is not yet implemented.&quot;</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># submit_edit_or_suggestion is an &quot;action&quot; routine.</span>
<span class="c"># which does the actual update of the wishlist for paint_item_change_form</span>
<span class="c"># and paint_suggestion_form</span>
<a name="submit_edit_or_suggestion-"></a><span class="k">sub </span><span class="m">submit_edit_or_suggestion</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$itemnum</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$validated_expiration</span> = <span class="i">validate_expiration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">$wishlist</span><span class="i">-&gt;suggest_update</span><span class="s">(</span>
        <span class="w">itemnum</span>     <span class="cm">=&gt;</span> <span class="i">$itemnum</span><span class="cm">,</span>
        <span class="w">description</span> <span class="cm">=&gt;</span> <span class="i">remove_tabs</span><span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">'description'</span><span class="s">)</span> <span class="s">)</span><span class="cm">,</span>
        <span class="w">by</span>          <span class="cm">=&gt;</span> <span class="i">$user</span><span class="cm">,</span>
        <span class="w">requested</span>   <span class="cm">=&gt;</span> <span class="i">param</span><span class="s">(</span><span class="q">'wanted'</span><span class="s">)</span><span class="cm">,</span>
        <span class="w">expires</span>     <span class="cm">=&gt;</span> <span class="i">$validated_expiration</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># paint_item_change_form is an &quot;action&quot; routine.</span>
<span class="c"># It sets up a form which lets the user edit an item and update the information</span>
<span class="c"># The actual update is done by submit_edit_or_suggestion</span>
<span class="c">#</span>
<a name="paint_item_change_form-"></a><span class="k">sub </span><span class="m">paint_item_change_form</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$which</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$itemnum</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$itemnum</span> = <span class="i">$which</span> <span class="s">)</span> =~ <span class="q">s/Edit //</span><span class="sc">;</span>

    <span class="k">print</span> <span class="i">start_form</span><span class="cm">,</span>
      <span class="i">table</span><span class="s">(</span>
        <span class="i">TR</span><span class="s">(</span>
            <span class="s">{</span> -<span class="w">align</span> <span class="cm">=&gt;</span> <span class="q">&quot;LEFT&quot;</span> <span class="s">}</span><span class="cm">,</span>
            <span class="i">th</span><span class="s">(</span><span class="q">'Gift Description'</span><span class="s">)</span><span class="cm">,</span>
            <span class="i">td</span><span class="s">(</span>
                <span class="i">textfield</span><span class="s">(</span>
                    -<span class="w">name</span>    <span class="cm">=&gt;</span> <span class="q">'description'</span><span class="cm">,</span>
                    -<span class="w">size</span>    <span class="cm">=&gt;</span> <span class="n">75</span><span class="cm">,</span>
                    -<span class="w">default</span> <span class="cm">=&gt;</span>
                      <span class="i">escapeHTML</span><span class="s">(</span> <span class="i">$wishlist</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$itemnum</span><span class="s">)</span><span class="i">-&gt;description</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="cm">,</span>
                <span class="s">)</span>
            <span class="s">)</span>
        <span class="s">)</span><span class="cm">,</span>
        <span class="i">quant_menu</span><span class="s">(</span>
            <span class="w">prompt</span>  <span class="cm">=&gt;</span> <span class="q">'Number wanted'</span><span class="cm">,</span>
            <span class="w">values</span>  <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">'any'</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span> <span class="n">4</span><span class="cm">,</span> <span class="n">5</span><span class="cm">,</span> <span class="n">6</span><span class="cm">,</span> <span class="n">7</span><span class="cm">,</span> <span class="n">8</span> <span class="s">]</span><span class="cm">,</span>
            <span class="w">default</span> <span class="cm">=&gt;</span> <span class="i">$wishlist</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$itemnum</span><span class="s">)</span><span class="i">-&gt;requested</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span>
        <span class="s">)</span><span class="cm">,</span>
        <span class="i">expires_menu</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span>
      <span class="s">)</span><span class="cm">,</span>
      <span class="w">br</span><span class="cm">,</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'owner'</span> <span class="s">)</span><span class="cm">,</span>
      <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'item'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$itemnum</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">paint_footer</span><span class="s">(</span> <span class="i">$which</span><span class="cm">,</span> <span class="q">&quot;Submit Edited Item&quot;</span><span class="cm">,</span> <span class="q">&quot;Delete $itemnum&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># quant_menu</span>
<span class="c"># returns the form segment for asking a quantity, typically the number wanted</span>

<a name="quant_menu-"></a><span class="k">sub </span><span class="m">quant_menu</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">%args</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">TR</span><span class="s">(</span>
        <span class="s">{</span> -<span class="w">align</span> <span class="cm">=&gt;</span> <span class="q">&quot;LEFT&quot;</span> <span class="s">}</span><span class="cm">,</span>
        <span class="i">th</span><span class="s">(</span> <span class="i">$args</span>{<span class="w">prompt</span>} <span class="s">)</span><span class="cm">,</span>
        <span class="i">td</span><span class="s">(</span>
            <span class="i">popup_menu</span><span class="s">(</span>
                -<span class="w">name</span>    <span class="cm">=&gt;</span> <span class="q">'wanted'</span><span class="cm">,</span>
                -<span class="w">values</span>  <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">values</span>}<span class="cm">,</span>
                -<span class="w">size</span>    <span class="cm">=&gt;</span> <span class="n">5</span><span class="cm">,</span>
                -<span class="w">default</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">default</span>}<span class="cm">,</span>
            <span class="s">)</span>
        <span class="s">)</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># expires_menu</span>
<span class="c"># returns the form segment for specifying an expiration date</span>
<span class="c"># Currently used only in paint_suggestion_form, but it should be generalized</span>

<a name="expires_menu-"></a><span class="k">sub </span><span class="m">expires_menu</span>
<span class="s">{</span>
    <span class="k">return</span> <span class="i">TR</span><span class="s">(</span>
        <span class="s">{</span> -<span class="w">align</span> <span class="cm">=&gt;</span> <span class="q">&quot;LEFT&quot;</span> <span class="s">}</span><span class="cm">,</span>
        <span class="i">th</span><span class="s">(</span><span class="q">'Expiration Date'</span><span class="s">)</span><span class="cm">,</span>
        <span class="i">td</span><span class="s">(</span>
            <span class="i">popup_menu</span><span class="s">(</span>
                -<span class="w">name</span>   <span class="cm">=&gt;</span> <span class="q">'expires_type'</span><span class="cm">,</span>
                -<span class="w">values</span> <span class="cm">=&gt;</span>
                  <span class="s">[</span> <span class="q">'Never'</span><span class="cm">,</span> <span class="q">'Date Selected'</span><span class="cm">,</span> <span class="q">'Christmas'</span><span class="cm">,</span> <span class="q">'In A Year'</span><span class="cm">,</span> <span class="s">]</span><span class="cm">,</span>
                -<span class="w">size</span>    <span class="cm">=&gt;</span> <span class="n">9</span><span class="cm">,</span>
                -<span class="w">default</span> <span class="cm">=&gt;</span> <span class="q">'Never'</span><span class="cm">,</span>
            <span class="s">)</span><span class="cm">,</span>
            <span class="i">popup_menu</span><span class="s">(</span>
                -<span class="w">name</span>   <span class="cm">=&gt;</span> <span class="q">'month_expires'</span><span class="cm">,</span>
                -<span class="w">values</span> <span class="cm">=&gt;</span> <span class="s">[</span>
                    <span class="q">'Jan'</span><span class="cm">,</span> <span class="q">'Feb'</span><span class="cm">,</span> <span class="q">'Mar'</span><span class="cm">,</span> <span class="q">'Apr'</span><span class="cm">,</span> <span class="q">'May'</span><span class="cm">,</span> <span class="q">'Jun'</span><span class="cm">,</span>
                    <span class="q">'Jul'</span><span class="cm">,</span> <span class="q">'Aug'</span><span class="cm">,</span> <span class="q">'Sep'</span><span class="cm">,</span> <span class="q">'Oct'</span><span class="cm">,</span> <span class="q">'Nov'</span><span class="cm">,</span> <span class="q">'Dec'</span><span class="cm">,</span>
                <span class="s">]</span><span class="cm">,</span>
                -<span class="w">size</span> <span class="cm">=&gt;</span> <span class="n">9</span><span class="cm">,</span>
            <span class="s">)</span><span class="cm">,</span>
            <span class="i">popup_menu</span><span class="s">(</span>
                -<span class="w">name</span>   <span class="cm">=&gt;</span> <span class="q">'day_expires'</span><span class="cm">,</span>
                -<span class="w">values</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="n">1</span> .. <span class="n">31</span> <span class="s">]</span><span class="cm">,</span>
                -<span class="w">size</span>   <span class="cm">=&gt;</span> <span class="n">9</span><span class="cm">,</span>
            <span class="s">)</span><span class="cm">,</span>
            <span class="i">popup_menu</span><span class="s">(</span>
                -<span class="w">name</span>   <span class="cm">=&gt;</span> <span class="q">'year_expires'</span><span class="cm">,</span>
                -<span class="w">values</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="n">2003</span> .. <span class="n">2010</span> <span class="s">]</span><span class="cm">,</span>
                -<span class="w">size</span>   <span class="cm">=&gt;</span> <span class="n">9</span><span class="cm">,</span>
            <span class="s">)</span><span class="cm">,</span>
        <span class="s">)</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># paint_suggestion_form is an &quot;action&quot; routine</span>
<span class="c"># It sets up the form to make a suggestion</span>
<span class="c"># (Although it is called by both &quot;add&quot; and &quot;change&quot;?</span>
<span class="c"># The actual update of the wishlist is done by paint_suggestion_confirmation</span>

<a name="paint_suggestion_form-"></a><span class="k">sub </span><span class="m">paint_suggestion_form</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$user</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">print</span> <span class="i">h1</span><span class="s">(</span>
        <span class="i">display_name</span><span class="s">(</span><span class="i">$user</span><span class="s">)</span><span class="cm">,</span>
        <span class="q">&quot; is adding a suggestion for &quot;</span><span class="cm">,</span>
        <span class="i">display_name</span><span class="s">(</span> <span class="i">$wishlist</span><span class="i">-&gt;userid</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span>
      <span class="s">)</span><span class="cm">,</span>
      <span class="w">start_form</span><span class="cm">,</span>
      <span class="i">table</span><span class="s">(</span>
        <span class="i">descrip_menu</span><span class="s">(</span><span class="q">'Gift Description'</span><span class="s">)</span><span class="cm">,</span>
        <span class="i">quant_menu</span><span class="s">(</span>
            <span class="w">prompt</span>  <span class="cm">=&gt;</span> <span class="q">'Number Wanted'</span><span class="cm">,</span>
            <span class="w">values</span>  <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">'any'</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span> <span class="n">4</span><span class="cm">,</span> <span class="n">5</span><span class="cm">,</span> <span class="n">6</span><span class="cm">,</span> <span class="n">7</span><span class="cm">,</span> <span class="n">8</span> <span class="s">]</span><span class="cm">,</span>
            <span class="w">default</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
        <span class="s">)</span><span class="cm">,</span>
      <span class="s">)</span><span class="cm">,</span>
      <span class="i">expires_menu</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="w">br</span><span class="cm">,</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'owner'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">paint_footer</span><span class="s">(</span> <span class="q">'Add Suggestion'</span><span class="cm">,</span> <span class="q">'Submit Suggestion'</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># error_page fills in the html page with an error message when there is an error</span>
<span class="c"># which prevents further processing</span>
<span class="c">#</span>
<a name="error_page-"></a><span class="k">sub </span><span class="m">error_page</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$error</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">print</span> <span class="i">header</span><span class="cm">,</span>
      <span class="i">start_html</span><span class="s">(</span>
        -<span class="w">title</span> <span class="cm">=&gt;</span> <span class="q">&quot;Wishlist Error Notification&quot;</span><span class="cm">,</span>
        -<span class="w">style</span> <span class="cm">=&gt;</span> <span class="s">{</span> -<span class="w">src</span> <span class="cm">=&gt;</span> <span class="i">stylefile</span><span class="s">(</span><span class="s">)</span> <span class="s">}</span>
      <span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">h1</span><span class="s">(</span> <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Warning'</span> <span class="s">}</span><span class="cm">,</span> <span class="i">$error</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">end_html</span><span class="sc">;</span>

    <span class="k">exit</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># print_warning be used used when a form has required fields missing</span>
<span class="c"># It is used to print a prompt prior to redrawing the partially completed form</span>
<span class="c">#</span>
<a name="print_warning-"></a><span class="k">sub </span><span class="m">print_warning</span>
<span class="s">{</span>

    <span class="k">print</span> <span class="i">p</span><span class="s">(</span>
        <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Warning'</span> <span class="s">}</span><span class="cm">,</span>
        <span class="q">'Please fill in the following fields: '</span><span class="cm">,</span>
        <span class="i">em</span><span class="s">(</span> <span class="k">join</span> <span class="s">(</span> <span class="q">', '</span><span class="cm">,</span> <span class="k">map</span> <span class="s">{</span> <span class="k">ucfirst</span> <span class="s">}</span> <span class="i">@_</span> <span class="s">)</span> <span class="s">)</span><span class="cm">,</span> <span class="q">'.'</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># paint_suggestion_confirmation is an &quot;action&quot; routine</span>
<span class="c"># Which prints a form repeating the suggestion information and checking with</span>
<span class="c"># the user that it is right. If so, the wishlist will actually be updated by</span>
<span class="c"># submit_edit_or_suggestion</span>

<a name="paint_suggestion_confirmation-"></a><span class="k">sub </span><span class="m">paint_suggestion_confirmation</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$user</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@REQUIRED</span> = <span class="q">qw/description wanted/</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@missing</span>  = <span class="i">check_missing</span><span class="s">(</span><span class="i">@REQUIRED</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">@missing</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">print_warning</span><span class="s">(</span><span class="i">@missing</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">paint_suggestion_form</span><span class="s">(</span> <span class="i">$wishlist</span><span class="cm">,</span> <span class="i">$user</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">@rows</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="s">(</span><span class="i">@REQUIRED</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="s">(</span>
            <span class="i">@rows</span><span class="cm">,</span>
            <span class="i">TR</span><span class="s">(</span>
                <span class="i">th</span><span class="s">(</span> <span class="s">{</span> -<span class="w">align</span> <span class="cm">=&gt;</span> <span class="q">&quot;LEFT&quot;</span> <span class="s">}</span><span class="cm">,</span> <span class="k">ucfirst</span> <span class="i">$_</span> <span class="s">)</span><span class="cm">,</span>
                <span class="i">td</span><span class="s">(</span> <span class="i">escapeHTML</span><span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="i">$_</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span>
            <span class="s">)</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">push</span> <span class="s">(</span>
        <span class="i">@rows</span><span class="cm">,</span>
        <span class="i">TR</span><span class="s">(</span>
            <span class="w">th</span> <span class="s">{</span> -<span class="w">align</span> <span class="cm">=&gt;</span> <span class="q">&quot;LEFT&quot;</span> <span class="s">}</span><span class="cm">,</span>
            <span class="q">'Expiration Date'</span><span class="cm">,</span>
            <span class="i">td</span><span class="s">(</span>
                <span class="i">param</span><span class="s">(</span><span class="q">'expires_type'</span><span class="s">)</span><span class="cm">,</span> <span class="i">param</span><span class="s">(</span><span class="q">'month_expires'</span><span class="s">)</span><span class="cm">,</span>
                <span class="i">param</span><span class="s">(</span><span class="q">'day_expires'</span><span class="s">)</span><span class="cm">,</span>  <span class="i">param</span><span class="s">(</span><span class="q">'year_expires'</span><span class="s">)</span><span class="cm">,</span>
            <span class="s">)</span>
        <span class="s">)</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">h1</span><span class="s">(</span>
        <span class="i">display_name</span><span class="s">(</span><span class="i">$user</span><span class="s">)</span><span class="cm">,</span>
        <span class="q">&quot; is adding a suggestion for &quot;</span><span class="cm">,</span>
        <span class="i">display_name</span><span class="s">(</span> <span class="i">$wishlist</span><span class="i">-&gt;userid</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span>
      <span class="s">)</span><span class="cm">,</span>
      <span class="q">&quot;Here is your suggested gift. Press &quot;</span><span class="cm">,</span> <span class="i">em</span><span class="s">(</span><span class="q">'Confirm'</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot; to save it, or &quot;</span><span class="cm">,</span>
      <span class="i">em</span><span class="s">(</span><span class="q">'Change'</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot; to change it.&quot;</span><span class="cm">,</span> <span class="w">hr</span><span class="cm">,</span> <span class="i">table</span><span class="s">(</span><span class="i">@rows</span><span class="s">)</span><span class="cm">,</span> <span class="w">hr</span><span class="sc">;</span>

    <span class="k">print</span> <span class="i">start_form</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'owner'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="s">(</span><span class="i">@REQUIRED</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">print</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">&quot;expires_type&quot;</span> <span class="s">)</span><span class="cm">,</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">&quot;month_expires&quot;</span> <span class="s">)</span><span class="cm">,</span>
      <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span>     <span class="cm">=&gt;</span> <span class="q">&quot;day_expires&quot;</span> <span class="s">)</span><span class="cm">,</span>  <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">&quot;year_expires&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">paint_footer</span><span class="s">(</span> <span class="q">'Submit Suggestion'</span><span class="cm">,</span> <span class="q">'Change Entry'</span><span class="cm">,</span> <span class="q">'Confirm Entry'</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># check_missing is a utility routine which can be called by a form processing</span>
<span class="c"># routine to check if required parameters are filled out.</span>
<span class="c"># The parameters are passed and the required parameters are listed in the global</span>
<span class="c"># array @REQUIRED</span>

<a name="check_missing-"></a><span class="k">sub </span><span class="m">check_missing</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">@REQUIRED</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">%p</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># Check each parameter and find all those which actually have data</span>
    <span class="k">grep</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="i">$_</span><span class="s">)</span> <span class="k">ne</span> <span class="q">''</span> &amp;&amp; <span class="i">$p</span>{<span class="i">$_</span>}++<span class="cm">,</span> <span class="i">param</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># Return any required param which does not exist or does not have data</span>
    <span class="k">return</span> <span class="k">grep</span><span class="s">(</span> !<span class="i">$p</span>{<span class="i">$_</span>}<span class="cm">,</span> <span class="i">@REQUIRED</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># push_user_item</span>
<span class="c"># format and push an item for someone other than the owner of the list to view</span>
<a name="push_user_item-"></a><span class="k">sub </span><span class="m">push_user_item(\@$$$)</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rowref</span><span class="cm">,</span> <span class="i">$item</span><span class="cm">,</span> <span class="i">$wl</span><span class="cm">,</span> <span class="i">$user</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$note_string</span><span class="sc">;</span>

    <span class="k">return</span> <span class="k">unless</span> <span class="k">defined</span> <span class="i">$item</span><span class="sc">;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$item</span><span class="i">-&gt;deleted</span><span class="s">(</span><span class="s">)</span>  <span class="k">and</span> !<span class="i">$item</span><span class="i">-&gt;purchased_by</span><span class="s">(</span><span class="i">$user</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$item</span><span class="i">-&gt;obsolete</span><span class="s">(</span><span class="s">)</span> <span class="k">and</span> !<span class="i">$item</span><span class="i">-&gt;purchased_by</span><span class="s">(</span><span class="i">$user</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span> = <span class="i">$item</span><span class="i">-&gt;ident</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$action_string</span> = <span class="s">(</span>
        <span class="i">$item</span><span class="i">-&gt;purchased_by</span><span class="s">(</span><span class="i">$user</span><span class="s">)</span> ? <span class="i">submit</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'action'</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">&quot;Release Item $id&quot;</span>
          <span class="s">)</span>
        <span class="co">:</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$item</span><span class="i">-&gt;wanted</span> !~ <span class="q">/^-?\d+$/</span> <span class="s">)</span> || <span class="s">(</span> <span class="i">$item</span><span class="i">-&gt;wanted</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">)</span> ? <span class="i">submit</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'action'</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">&quot;Buy Item $id&quot;</span>
          <span class="s">)</span>
        <span class="co">:</span> <span class="q">&quot;Gone&quot;</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># If the user suggested this item, let him edit it.</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$item</span><span class="i">-&gt;by</span><span class="s">(</span><span class="s">)</span> <span class="k">eq</span> <span class="i">$user</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$note_string</span> = <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'action'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">&quot;Edit $id&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># If someone other than the owner or this user suggested the item</span>
        <span class="c"># Display who did in the notes</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$item</span><span class="i">-&gt;by</span><span class="s">(</span><span class="s">)</span> <span class="k">ne</span> <span class="i">$wl</span><span class="i">-&gt;userid</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$note_string</span> = <span class="q">&quot;Suggested by &quot;</span> . <span class="i">display_name</span><span class="s">(</span> <span class="i">$item</span><span class="i">-&gt;by</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># Create a string of the item notes,</span>
    <span class="c"># including tsuggester part previously set.</span>
    <span class="i">$note_string</span> .= <span class="k">join</span> <span class="s">(</span> <span class="q">&quot; &quot;</span><span class="cm">,</span> <span class="k">map</span> <span class="s">{</span> <span class="i">p</span><span class="s">(</span> <span class="i">escapeHTML</span><span class="s">(</span><span class="i">$_</span><span class="s">)</span> <span class="s">)</span> <span class="s">}</span> <span class="i">@</span>{ <span class="i">$item</span><span class="i">-&gt;notes</span> } <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@cells</span> = <span class="s">[</span>
        <span class="i">$action_string</span><span class="cm">,</span>                     <span class="i">$item</span><span class="i">-&gt;wanted</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span>
        <span class="i">escapeHTML</span><span class="s">(</span> <span class="i">$item</span><span class="i">-&gt;description</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="cm">,</span> <span class="i">$item</span><span class="i">-&gt;bought</span><span class="cm">,</span>
        <span class="i">$item</span><span class="i">-&gt;expiration_date</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span>           <span class="i">$note_string</span><span class="cm">,</span>
    <span class="s">]</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$item</span><span class="i">-&gt;deleted</span><span class="s">(</span><span class="s">)</span> <span class="k">or</span> <span class="i">$item</span><span class="i">-&gt;obsolete</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span>
        <span class="k">and</span> <span class="i">$item</span><span class="i">-&gt;purchased_by</span><span class="s">(</span><span class="i">$user</span><span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="s">(</span> <span class="i">@</span>{<span class="i">$rowref</span>}<span class="cm">,</span> <span class="q">&quot;\n&quot;</span> . <span class="i">td</span><span class="s">(</span> <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'obsolete'</span> <span class="s">}</span><span class="cm">,</span> <span class="i">@cells</span><span class="cm">,</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">push</span> <span class="s">(</span> <span class="i">@</span>{<span class="i">$rowref</span>}<span class="cm">,</span> <span class="q">&quot;\n&quot;</span> . <span class="i">td</span><span class="s">(</span> <span class="i">@cells</span><span class="cm">,</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># push_owner_item</span>
<span class="c"># pushes a table entry for an item formatted for the owner of the list to view</span>
<a name="push_owner_item-"></a><span class="k">sub </span><span class="m">push_owner_item(\@$$)</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rowref</span><span class="cm">,</span> <span class="i">$item</span><span class="cm">,</span> <span class="i">$wl</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="k">defined</span> <span class="i">$item</span><span class="sc">;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="i">$item</span><span class="i">-&gt;deleted</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$item</span><span class="i">-&gt;by</span><span class="s">(</span><span class="s">)</span> <span class="k">ne</span> <span class="i">$wl</span><span class="i">-&gt;userid</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$id</span>    = <span class="i">$item</span><span class="i">-&gt;ident</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@cells</span> = <span class="s">[</span>
        <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'action'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">&quot;Delete $id&quot;</span> <span class="s">)</span><span class="cm">,</span>
        <span class="i">$item</span><span class="i">-&gt;requested</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span>
        <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'action'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">&quot;Edit $id&quot;</span> <span class="s">)</span><span class="cm">,</span>
        <span class="i">escapeHTML</span><span class="s">(</span> <span class="i">$item</span><span class="i">-&gt;description</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="cm">,</span>
        <span class="i">$item</span><span class="i">-&gt;expiration_date</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span>
    <span class="s">]</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$item</span><span class="i">-&gt;obsolete</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="s">(</span> <span class="i">@</span>{<span class="i">$rowref</span>}<span class="cm">,</span> <span class="q">&quot;\n&quot;</span> . <span class="i">td</span><span class="s">(</span> <span class="s">{</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'obsolete'</span> <span class="s">}</span><span class="cm">,</span> <span class="i">@cells</span><span class="cm">,</span> <span class="s">)</span><span class="cm">,</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">push</span> <span class="s">(</span> <span class="i">@</span>{<span class="i">$rowref</span>}<span class="cm">,</span> <span class="q">&quot;\n&quot;</span> . <span class="i">td</span><span class="s">(</span> <span class="i">@cells</span> <span class="s">)</span><span class="cm">,</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># paint_wishlist is an &quot;action&quot;routine and the default action item.</span>
<span class="c"># It displays a page with a table showing the list of suggestions</span>
<span class="c"># either formatted for the owner or for anyone else.</span>
<span class="c">#</span>
<a name="paint_wishlist-"></a><span class="k">sub </span><span class="m">paint_wishlist</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$wl</span><span class="cm">,</span> <span class="i">$user</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@rows</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@items</span> = <span class="i">$wl</span><span class="i">-&gt;get_items</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$owner</span> = <span class="i">$wl</span><span class="i">-&gt;userid</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># @items is an array of WishItem objects each giving a value for</span>
    <span class="c"># for - Who this suggestion is for; in this case it should always be $owner</span>
    <span class="c"># by  - Who created the suggestion</span>
    <span class="c"># wanted - Number of this item currently desired</span>
    <span class="c">#          (either an integer or a string)</span>
    <span class="c"># description - Description of the item</span>

    <span class="c"># Create the header</span>
    <span class="k">push</span> <span class="s">(</span>
        <span class="i">@rows</span><span class="cm">,</span>
        <span class="i">th</span><span class="s">(</span>
            <span class="s">(</span> <span class="i">$wl</span><span class="i">-&gt;userid</span><span class="s">(</span><span class="s">)</span> <span class="k">eq</span> <span class="i">$user</span> <span class="s">)</span>
            ? <span class="s">[</span> <span class="q">'Delete'</span><span class="cm">,</span> <span class="q">'Wanted'</span><span class="cm">,</span> <span class="q">'Edit'</span><span class="cm">,</span> <span class="q">'Description'</span><span class="cm">,</span> <span class="q">'Expires'</span><span class="cm">,</span> <span class="s">]</span>
            <span class="co">:</span> <span class="s">[</span>
                <span class="q">'Buy'</span><span class="cm">,</span>     <span class="q">'Needed'</span><span class="cm">,</span> <span class="q">'Description'</span><span class="cm">,</span> <span class="q">'Purchased'</span><span class="cm">,</span>
                <span class="q">'Expires'</span><span class="cm">,</span> <span class="q">'Notes'</span>
            <span class="s">]</span>
        <span class="s">)</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$wl</span><span class="i">-&gt;userid</span><span class="s">(</span><span class="s">)</span> <span class="k">eq</span> <span class="i">$user</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$item</span> <span class="s">(</span><span class="i">@items</span><span class="s">)</span> <span class="s">{</span> <span class="i">push_owner_item</span><span class="s">(</span> <span class="i">@rows</span><span class="cm">,</span> <span class="i">$item</span><span class="cm">,</span> <span class="i">$wl</span> <span class="s">)</span> <span class="s">}</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$item</span> <span class="s">(</span><span class="i">@items</span><span class="s">)</span> <span class="s">{</span> <span class="i">push_user_item</span><span class="s">(</span> <span class="i">@rows</span><span class="cm">,</span> <span class="i">$item</span><span class="cm">,</span> <span class="i">$wl</span><span class="cm">,</span> <span class="i">$user</span> <span class="s">)</span> <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">print</span> <span class="i">h1</span><span class="s">(</span> <span class="q">&quot;Viewing the Wish List for &quot;</span><span class="cm">,</span> <span class="i">display_name</span><span class="s">(</span><span class="i">$owner</span><span class="s">)</span> <span class="s">)</span><span class="cm">,</span> <span class="i">startform</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span>
      <span class="q">&quot;\n&quot;</span><span class="cm">,</span> <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'action'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">&quot;Add Suggestion&quot;</span> <span class="s">)</span><span class="cm">,</span>
      <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'action'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'Pick Another List'</span> <span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n&quot;</span><span class="cm">,</span>

      <span class="i">h3</span><span class="s">(</span> <span class="q">&quot;Last modified by owner &quot;</span>
          . <span class="i">display_name</span><span class="s">(</span><span class="i">$owner</span><span class="s">)</span> . <span class="q">&quot; on &quot;</span>
          . <span class="k">localtime</span><span class="s">(</span> <span class="i">$wl</span><span class="i">-&gt;last_update</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n&quot;</span><span class="cm">,</span>

      <span class="i">table</span><span class="s">(</span>
        <span class="s">{</span> -<span class="w">border</span> <span class="cm">=&gt;</span> <span class="q">''</span> <span class="s">}</span><span class="cm">,</span>
        <span class="i">caption</span><span class="s">(</span> <span class="i">strong</span><span class="s">(</span><span class="q">&quot;Wish List for $owner&quot;</span><span class="s">)</span> <span class="s">)</span><span class="cm">,</span>
        <span class="i">TR</span><span class="s">(</span> \<span class="i">@rows</span> <span class="s">)</span>
      <span class="s">)</span><span class="cm">,</span>
      <span class="w">br</span><span class="cm">,</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'owner'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">paint_footer</span><span class="s">(</span> <span class="k">undef</span><span class="cm">,</span> <span class="q">&quot;Add Suggestion&quot;</span><span class="cm">,</span> <span class="q">&quot;Pick Another List&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># paint_owner_choice_form - utility routine used to display a form allowing</span>
<span class="c"># the user to choose a wishlist to work on</span>
<span class="c">#</span>
<a name="paint_owner_choice_form-"></a><span class="k">sub </span><span class="m">paint_owner_choice_form</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$user</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%lists</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$person</span> <span class="s">(</span> <span class="k">glob</span><span class="s">(</span><span class="q">&quot;$glrepository/person.*&quot;</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$person</span> =~ <span class="q">s[$glrepository/person\.][]</span><span class="sc">;</span>
        <span class="s">(</span> <span class="i">$lists</span>{<span class="i">$person</span>} <span class="s">)</span> = <span class="i">attributes_for</span><span class="s">(</span> <span class="i">$person</span><span class="cm">,</span> <span class="q">'name'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">print</span> <span class="i">h1</span><span class="s">(</span><span class="i">$gltitle</span><span class="s">)</span><span class="cm">,</span> <span class="i">startform</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span>
      <span class="i">radio_group</span><span class="s">(</span>
        -<span class="w">name</span>    <span class="cm">=&gt;</span> <span class="q">'owner'</span><span class="cm">,</span>
        -<span class="w">values</span>  <span class="cm">=&gt;</span> <span class="s">[</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%lists</span> <span class="s">)</span> <span class="s">]</span><span class="cm">,</span>
        -<span class="w">labels</span>  <span class="cm">=&gt;</span> \<span class="i">%lists</span><span class="cm">,</span>
        -<span class="w">default</span> <span class="cm">=&gt;</span> <span class="i">$user</span><span class="cm">,</span>
        -<span class="w">cols</span>    <span class="cm">=&gt;</span> <span class="n">4</span><span class="cm">,</span>
      <span class="s">)</span><span class="sc">;</span>
    <span class="i">paint_footer</span><span class="s">(</span> <span class="q">'Pick Another List'</span><span class="cm">,</span> <span class="q">'Choose list'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">paint_style_menu</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">end_form</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">end_html</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">exit</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># Routine to read any needed attributes for a particular user.</span>
<span class="c"># The routine should cache any attributes it does get, and return them</span>
<span class="c"># without reading the file.</span>

<a name="attributes_for-"></a><span class="k">sub </span><span class="m">attributes_for</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$person</span><span class="cm">,</span> <span class="i">@atts</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%UserValues</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@response</span><span class="sc">;</span>

    <span class="k">open</span> <span class="w">PERSON</span><span class="cm">,</span> <span class="q">&quot;$glrepository/person.$person&quot;</span>
      <span class="k">or</span> <span class="k">print</span> <span class="q">&quot;I don't have any information on $person&quot;</span><span class="cm">,</span> <span class="w">br</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span><span class="q">&lt;PERSON&gt;</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">chomp</span><span class="sc">;</span>
        <span class="q">s/#.*//</span><span class="sc">;</span>
        <span class="q">s/^\s+//</span><span class="sc">;</span>
        <span class="k">next</span> <span class="k">unless</span> <span class="k">length</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$var</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span> = <span class="k">split</span> <span class="s">(</span> <span class="q">/\s*=\s*/</span><span class="cm">,</span> <span class="i">$_</span><span class="cm">,</span> <span class="n">2</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$temp</span> = <span class="i">$UserValues</span>{<span class="i">$var</span>} = <span class="i">$value</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">foreach</span> <span class="s">(</span><span class="i">@atts</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">unshift</span> <span class="i">@response</span><span class="cm">,</span> <span class="i">$UserValues</span>{<span class="i">$_</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="k">wantarray</span><span class="s">(</span><span class="s">)</span> ? <span class="i">@response</span> <span class="co">:</span> <span class="i">$response</span>[<span class="n">0</span>]<span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>

<a name="__END__-"></a><span class="k">__END__</span>

</pre><pre><a name="EOF-"></a></pre>    </BODY>

    </HTML>
