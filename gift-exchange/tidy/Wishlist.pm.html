<!-- Generated by perltidy on Mon Jan 20 23:46:56 2003 -->
    <HTML> 
	<HEAD> 
	    <TITLE>Wishlist.pm - Perl Module to manage Gift Wishlists

</TITLE> 
	</HEAD>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #FFFFFF;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
	<BODY>
<a name="-top-"></a>
<h1>Wishlist.pm</h1>

<!-- INDEX BEGIN -->

<UL>

	<LI><A HREF="#NAME">NAME</A>
	<LI><A HREF="#VERSION">VERSION</A>
	<LI><A HREF="#SYNOPSIS">SYNOPSIS</A>
	<LI><A HREF="#DESCRIPTION">DESCRIPTION</A>
	<UL>

		<LI><A HREF="#Overview">Overview</A>
		<LI><A HREF="#Constructor_and_initialization">Constructor and initialization</A>
		<LI><A HREF="#Class_and_object_methods">Class and object methods</A>
		<LI><A HREF="#Any_other_information_that_s_imp">Any other information that's important</A>
	</UL>

	<LI><A HREF="#ENVIRONMENT">ENVIRONMENT</A>
	<LI><A HREF="#DIAGNOSTICS">DIAGNOSTICS</A>
	<LI><A HREF="#ENHANCEMENTS">ENHANCEMENTS</A>
	<LI><A HREF="#REFACTORINGS">REFACTORINGS</A>
	<LI><A HREF="#BUGS">BUGS</A>
	<LI><A HREF="#FILES">FILES</A>
	<LI><A HREF="#SEE_ALSO">SEE ALSO</A>
	<LI><A HREF="#AUTHOR">AUTHOR</A>
	<LI><A HREF="#COPYRIGHT">COPYRIGHT</A>
</UL>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Christmas::Wishlist-">package Christmas::Wishlist</a>
<ul>
<li><a href="#set_repository-">set_repository</a></li>
<li><a href="#_get_repository-">_get_repository</a></li>
<li><a href="#new-">new</a></li>
<li><a href="#_init-">_init</a></li>
<li><a href="#_numeric_time-">_numeric_time</a></li>
<li><a href="#_date_parts-">_date_parts</a></li>
<li><a href="#_read-">_read</a></li>
<li><a href="#_filename-">_filename</a></li>
<li><a href="#_write_header-">_write_header</a></li>
<li><a href="#_update-">_update</a></li>
<li><a href="#_tranlog-">_tranlog</a></li>
<li><a href="#_print_log-">_print_log</a></li>
<li><a href="#remove-">remove</a></li>
<li><a href="#_delete-">_delete</a></li>
<li><a href="#purchase-">purchase</a></li>
<li><a href="#_bought-">_bought</a></li>
<li><a href="#suggest_update-">suggest_update</a></li>
<li><a href="#userid-">userid</a></li>
<li><a href="#item-">item</a></li>
<li><a href="#last_update-">last_update</a></li>
<li><a href="#get_items-">get_items</a></li>
<li><a href="#_unindent-">_unindent</a></li>
</ul>
</li>
<li><a href="#__END__-">__END__</a></li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<HR>

<P>
<HR>
<H1><A NAME="NAME">NAME

</A></H1>
Wishlist.pm - Perl Module to manage Gift Wishlists


<P>

<P>
<HR>
<H1><A NAME="VERSION">VERSION

</A></H1>
This document refers to version 0.80 of Christmas::Wishlist, released Jan
1, 2003.


<P>

<P>
<HR>
<H1><A NAME="SYNOPSIS">SYNOPSIS

</A></H1>
<PRE>    include Christmas::Wishlist;
</PRE>

<P>

<PRE>    $wl = Christmas::Wishlist-&gt;new(userid=&gt;$user, create=[0|1], path=&lt;dirpath&gt;);
    $wl-&gt;suggest_update(by=&gt;, [itemnum=&gt;], description=&gt;, requested=&gt;, expires=&gt;);
    $wl-&gt;remove(by=&gt;, itemnum=&gt;, description=&gt;, howmany=&gt;);
    $wl-&gt;purchase(by=&gt;, itemnum=&gt;, description=&gt;, howmany=&gt;);
    $wl-&gt;item(               );
    @itemlist = $wl-&gt;get_items(               );
    $wl-&gt;userid();
    $wl-&gt;last_update();
</PRE>

<P>

<P>
<HR>
<H1><A NAME="DESCRIPTION">DESCRIPTION

</A></H1>
<P>
<HR>
<H2><A NAME="Overview">Overview

</A></H2>
<P>
<HR>
<H2><A NAME="Constructor_and_initialization">Constructor and initialization

</A></H2>
<P>
<HR>
<H2><A NAME="Class_and_object_methods">Class and object methods

</A></H2>
<P>
<HR>
<H2><A NAME="Any_other_information_that_s_imp">Any other information that's important

</A></H2>
<P>
<HR>
<H1><A NAME="ENVIRONMENT">ENVIRONMENT

</A></H1>
<P>
<HR>
<H1><A NAME="DIAGNOSTICS">DIAGNOSTICS

</A></H1>
<DL>
<DT><STRONG><A NAME="item__error">"error message that may appear"

</A></STRONG><DD>
Explanation of error message


<P>

</DL>
<P>
<HR>
<H1><A NAME="ENHANCEMENTS">ENHANCEMENTS

</A></H1>
<P>
<HR>
<H1><A NAME="REFACTORINGS">REFACTORINGS

</A></H1>
<PRE> Move NEWTRANS into object.
</PRE>

<P>

<PRE> Change to explicit parameters to new in suggest_update
</PRE>

<P>

<P>
<HR>
<H1><A NAME="BUGS">BUGS

</A></H1>
Bad data in the file should be reported, not cause a failure to return. For
instance, bad date fields should be appropriately reported as ``Bad''.


<P>

<P>
<HR>
<H1><A NAME="FILES">FILES

</A></H1>
<P>
<HR>
<H1><A NAME="SEE_ALSO">SEE ALSO

</A></H1>
<P>
<HR>
<H1><A NAME="AUTHOR">AUTHOR

</A></H1>
Michael G. Birdsall


<P>

<P>
<HR>
<H1><A NAME="COPYRIGHT">COPYRIGHT

</A></H1>
Copyright (c) 2002,2003, Michael G. Birdsall. All Rights Reserved. This
module is free software. It may be used, redistributed and/or modified
under the same terms as Perl itself.


<P>

</DL>
<hr /><pre>#!/usr/local/bin/perl -w
<span class="c"># $Id: Wishlist.pm,v 1.18 2003/01/17 03:58:32 mbirdsal Exp $</span>
<span class="c"># $Name:  $</span>
<span class="c">#</span>
<span class="c"># Module to manage user wishlist objects.</span>
<span class="c"># Wishlists are stored in a file in the repository at $defdir</span>
<span class="c"># The filename is wishlist.&lt;owner&gt; where &lt;owner&gt; is the userid</span>
<span class="c"># of the person whose wishlist it is.</span>
<span class="c">#</span>
<span class="c"># The file can have commentary records starting with a #</span>
<span class="c"># or transaction records including:</span>
<span class="c">#  |&lt;when&gt; &lt;whom&gt; added  &lt;author&gt; &lt;description&gt; &lt;needed&gt; &lt;expires&gt;</span>
<span class="c">#  |&lt;when&gt; &lt;whom&gt; bought &lt;author&gt; &lt;description&gt; &lt;num-bought&gt;</span>
<span class="c">#  |&lt;when&gt; &lt;whom&gt; delete &lt;author&gt; &lt;description&gt; </span>
<span class="c">#</span>
<span class="c"># where fields are separated by tabs.</span>
<span class="c">#</span>
<span class="c"># Modules:</span>
<span class="c">#    new</span>
<span class="c">#    suggest_update</span>
<span class="c">#    remove</span>
<span class="c">#    purchase</span>
<span class="c">#    item</span>
<span class="c">#    get_items</span>
<span class="c">#    last_update</span>
<span class="c"># </span>

<a name="package-Christmas::Wishlist-"></a><span class="k">package </span><span class="i">Christmas::Wishlist</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">lib</span> <span class="q">&quot;/users/m/mbirdsal/perllib/&quot;</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Christmas::Wishlist::WishItem</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Time::Local</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Carp</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c"># Ultimately, a repository will probably need to be an attribute of a wishlist, </span>
<span class="c"># or an object all on its own. </span>
<span class="c"># For now, we use a closure to make it a class attribute.</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$defdir</span><span class="sc">;</span>

    <span class="c"># Common values on a bert or on mbirdsal are:</span>
    <span class="c"># &quot;/users/m/mbirdsal/apache/htdocs/family/data/&quot;;</span>
    <span class="c"># &quot;/big/dom/xkirkbird/www/mbirdsall/family/data/&quot;;</span>

<a name="set_repository-"></a>    <span class="k">sub </span><span class="m">set_repository</span>
    <span class="s">{</span>
        <span class="k">shift</span><span class="sc">;</span>
        <span class="i">$defdir</span> = <span class="k">shift</span><span class="sc">;</span>
        <span class="k">return</span> <span class="i">$defdir</span><span class="sc">;</span>
    <span class="s">}</span>

<a name="_get_repository-"></a>    <span class="k">sub </span><span class="m">_get_repository</span>
    <span class="s">{</span>
        <span class="k">return</span> <span class="i">$defdir</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c"># Create a wishlist object </span>
<span class="c"># </span>
<span class="c"># Attributes to add to the object: Last Updated</span>
<a name="new-"></a><span class="k">sub </span><span class="m">new</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$class</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$class</span> = <span class="k">ref</span><span class="s">(</span><span class="i">$class</span><span class="s">)</span> || <span class="i">$class</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">bless</span> <span class="s">{</span><span class="s">}</span><span class="cm">,</span> <span class="i">$class</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;_init</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c"># Set the initial data</span>
<span class="c">#</span>
<span class="c"># Arguments: a hash contain the following keyed items:</span>
<span class="c">#      userid =&gt; login id of the user whose wishlist is being initialized (req)</span>
<span class="c">#      path   =&gt; a repository path for the wishlist (optional); defaults to the</span>
<span class="c">#                directory set with set_repository</span>
<span class="c">#      create =&gt; determines special create checks if defined (boolean)</span>
<span class="c">#                false -&gt; fail if the wishlist isn't already in existence</span>
<span class="c">#                         (refuse to create a new wishlist)</span>
<span class="c">#                true  -&gt; fail if the wishlist is already in existence</span>
<span class="c">#                         (refuse to use an existing wishlist</span>
<span class="c">#      when   =&gt; records the time the wishlist was last updated </span>
<span class="c">#</span>
<a name="_init-"></a><span class="k">sub </span><span class="m">_init</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">%arg</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="i">%$self</span> = <span class="s">(</span>
        <span class="w">_userid</span> <span class="cm">=&gt;</span> <span class="i">$arg</span>{<span class="w">userid</span>} || <span class="i">croak</span><span class="s">(</span><span class="q">&quot;missing userid&quot;</span><span class="s">)</span><span class="cm">,</span>
        <span class="w">_path</span>   <span class="cm">=&gt;</span> <span class="i">$arg</span>{<span class="w">path</span>}   || <span class="i">$self</span><span class="i">-&gt;_get_repository</span><span class="cm">,</span>
        <span class="w">_item</span>   <span class="cm">=&gt;</span> <span class="s">[</span><span class="s">]</span><span class="cm">,</span>
        <span class="w">_last_update</span> <span class="cm">=&gt;</span> <span class="q">&quot;unknown&quot;</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># form filename</span>
    <span class="k">my</span> <span class="i">$fname</span> = <span class="i">$self</span><span class="i">-&gt;_filename</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># If wishlist already exists</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">-f</span> <span class="i">$fname</span> &amp;&amp; <span class="k">-s</span> <span class="i">_</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$arg</span>{<span class="w">create</span>} <span class="k">and</span> <span class="i">$arg</span>{<span class="w">create</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="c"># Read the file and initialize the object from the data</span>
        <span class="i">$self</span><span class="i">-&gt;_read</span><span class="s">(</span><span class="i">$fname</span><span class="s">)</span><span class="sc">;</span>

        <span class="k">open</span><span class="s">(</span> <span class="w">NEWTRANS</span><span class="cm">,</span> <span class="q">&quot;&gt;&gt;$fname&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$arg</span>{<span class="w">create</span>} <span class="k">and</span> !<span class="i">$arg</span>{<span class="w">create</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="c"># Create the file</span>
        <span class="k">open</span><span class="s">(</span> <span class="w">NEWTRANS</span><span class="cm">,</span> <span class="q">&quot;&gt;&quot;</span> . <span class="i">$fname</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$self</span><span class="i">-&gt;_write_header</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

        <span class="c">#If this is a truly new file, this is the time of last update</span>
        <span class="i">$self</span>-&gt;{<span class="w">_last_update</span>} = <span class="k">localtime</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># _numeric_time</span>
<span class="c">#    returns the local (seconds from start of epoch) time for a time string</span>
<span class="c">#    formatted like the return from scalar localtime</span>
<span class="c">#</span>
<a name="_numeric_time-"></a><span class="k">sub </span><span class="m">_numeric_time</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$time</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">%numericmonth</span><span class="s">)</span> = <span class="s">(</span>
        <span class="w">Jan</span> <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span>
        <span class="w">Feb</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
        <span class="w">Mar</span> <span class="cm">=&gt;</span> <span class="n">2</span><span class="cm">,</span>
        <span class="w">Apr</span> <span class="cm">=&gt;</span> <span class="n">3</span><span class="cm">,</span>
        <span class="w">May</span> <span class="cm">=&gt;</span> <span class="n">4</span><span class="cm">,</span>
        <span class="w">Jun</span> <span class="cm">=&gt;</span> <span class="n">5</span><span class="cm">,</span>
        <span class="w">Jul</span> <span class="cm">=&gt;</span> <span class="n">6</span><span class="cm">,</span>
        <span class="w">Aug</span> <span class="cm">=&gt;</span> <span class="n">7</span><span class="cm">,</span>
        <span class="w">Sep</span> <span class="cm">=&gt;</span> <span class="n">8</span><span class="cm">,</span>
        <span class="w">Oct</span> <span class="cm">=&gt;</span> <span class="n">9</span><span class="cm">,</span>
        <span class="w">Nov</span> <span class="cm">=&gt;</span> <span class="n">10</span><span class="cm">,</span>
        <span class="w">Dec</span> <span class="cm">=&gt;</span> <span class="n">11</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$mmm</span><span class="cm">,</span> <span class="i">$dd</span><span class="cm">,</span> <span class="i">$hh</span><span class="cm">,</span> <span class="i">$min</span><span class="cm">,</span> <span class="i">$sec</span><span class="cm">,</span> <span class="i">$yyyy</span> <span class="s">)</span> =
      <span class="s">(</span> <span class="i">$time</span> =~ <span class="q">/\w*\s+(\w{3})\s+(\d*)\s+(\d+):(\d+):(\d+)\s+(\d+)/</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">timelocal</span><span class="s">(</span> <span class="i">$sec</span><span class="cm">,</span> <span class="i">$min</span><span class="cm">,</span> <span class="i">$hh</span><span class="cm">,</span> <span class="i">$dd</span><span class="cm">,</span> <span class="i">$numericmonth</span>{<span class="i">$mmm</span>}<span class="cm">,</span> <span class="i">$yyyy</span> - <span class="n">1900</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># _date_parts</span>
<span class="c">#    Breaks o date of the form:</span>
<span class="c">#        Sat Jan 11 17:00:55 2003</span>
<span class="c">#    out to get just the date information, e.g. qw(Jan 11 2003)</span>
<a name="_date_parts-"></a><span class="k">sub </span><span class="m">_date_parts</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$dstring</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$dstring</span> =~ <span class="q">/\w*\s+(\w{3})\s+(\d*)\s+\d+:\d+:\d+\s+(\d+)/</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># _read - reads the wishlist file whose name is passed and update the wishlist </span>
<span class="c">#         items based on the log in that file</span>

<a name="_read-"></a><span class="k">sub </span><span class="m">_read</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">$fname</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">open</span><span class="s">(</span> <span class="w">NEWTRANS</span><span class="cm">,</span> <span class="q">&quot;$fname&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span><span class="q">&lt;NEWTRANS&gt;</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">chomp</span><span class="sc">;</span>
        <span class="k">next</span> <span class="k">if</span> <span class="q">/^\s*#/</span><span class="sc">;</span>
        <span class="k">next</span> <span class="k">if</span> <span class="q">/^\s*$/</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$time</span><span class="cm">,</span> <span class="i">$author</span><span class="cm">,</span> <span class="i">$transcode</span><span class="cm">,</span> <span class="i">$itemnum</span><span class="cm">,</span> <span class="i">$descrip</span><span class="cm">,</span> <span class="i">$num</span><span class="cm">,</span> <span class="i">$expdate</span> <span class="s">)</span> =
          <span class="k">split</span> <span class="s">(</span><span class="q">/\t/</span><span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="s">(</span><span class="i">$update_time</span><span class="s">)</span> = <span class="i">_numeric_time</span><span class="s">(</span><span class="i">$time</span><span class="s">)</span><span class="sc">;</span>

        <span class="c"># Handle the proper transactions</span>
        <span class="j">SWITCH:</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$transcode</span> =~ <span class="q">/^add/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">unless</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$expdate</span> <span class="s">)</span> <span class="s">{</span>

                    <span class="c"># Set an expiration date one year after the add</span>
                    <span class="k">my</span> <span class="s">(</span> <span class="i">$mmm</span><span class="cm">,</span> <span class="i">$dd</span><span class="cm">,</span> <span class="i">$yyyy</span> <span class="s">)</span> = <span class="i">_date_parts</span><span class="s">(</span><span class="i">$time</span><span class="s">)</span><span class="sc">;</span>
                    <span class="i">$yyyy</span>++<span class="sc">;</span>
                    <span class="i">$expdate</span> = <span class="q">&quot;$mmm $dd $yyyy&quot;</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="i">$self</span><span class="i">-&gt;_update</span><span class="s">(</span> <span class="i">$itemnum</span><span class="cm">,</span> <span class="i">$descrip</span><span class="cm">,</span> <span class="i">$num</span><span class="cm">,</span> <span class="i">$author</span><span class="cm">,</span> <span class="i">$update_time</span><span class="cm">,</span>
                    <span class="i">$expdate</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">last</span> <span class="j">SWITCH</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$transcode</span> =~ <span class="q">/^del/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$self</span><span class="i">-&gt;_delete</span><span class="s">(</span> <span class="i">$itemnum</span><span class="cm">,</span> <span class="i">$update_time</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">last</span> <span class="j">SWITCH</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$transcode</span> =~ <span class="q">/^bou/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$self</span><span class="i">-&gt;_bought</span><span class="s">(</span> <span class="i">$itemnum</span><span class="cm">,</span> <span class="i">$descrip</span><span class="cm">,</span> <span class="i">$num</span><span class="cm">,</span> <span class="i">$author</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">last</span> <span class="j">SWITCH</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c"># Create the filename for a wishlist</span>
<span class="c"># Uses the path and userid to create the full path to the wishlist file</span>
<a name="_filename-"></a><span class="k">sub </span><span class="m">_filename</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">%arg</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span>-&gt;{<span class="w">_path</span>} . <span class="q">&quot;wishlist.&quot;</span> . <span class="i">$self</span>-&gt;{<span class="w">_userid</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># _write_header</span>
<span class="c"># </span>
<span class="c"># Writes the header lines at the top of a new wishlist file</span>
<a name="_write_header-"></a><span class="k">sub </span><span class="m">_write_header</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$self</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$userid</span> = <span class="i">$self</span>-&gt;{<span class="w">_userid</span>}<span class="sc">;</span>
    <span class="k">print</span> <span class="i">NEWTRANS</span> <span class="i">_unindent</span><span class="s">(</span><span class="h">&lt;&lt;&quot;ENDHEADER&quot;</span><span class="s">)</span><span class="sc">;</span>
<span class="hh">        #Defining a wishlist for $userid</span>
<span class="hh">        #Local Day, Time, and Date\twho\top\tident\tdescription\tnum\texpires </span>
<span class="h">ENDHEADER</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># _update </span>
<span class="c">#     changes the object using the information in a logfile add transaction</span>
<span class="c">#</span>
<span class="c"># Part of the 'read&quot; subsystem that deals with an existing wishlist.</span>
<a name="_update-"></a><span class="k">sub </span><span class="m">_update</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">$itemnum</span><span class="cm">,</span> <span class="i">$descrip</span><span class="cm">,</span> <span class="i">$num</span><span class="cm">,</span> <span class="i">$author</span><span class="cm">,</span> <span class="i">$update_time</span><span class="cm">,</span> <span class="i">$expires</span> <span class="s">)</span> =
      <span class="i">@_</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$self</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$itemnum</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$itemnum</span><span class="s">)</span><span class="i">-&gt;description</span><span class="s">(</span><span class="i">$descrip</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$self</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$itemnum</span><span class="s">)</span><span class="i">-&gt;requested</span><span class="s">(</span><span class="i">$num</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">_last_update</span>} = <span class="i">$update_time</span><span class="sc">;</span>
        <span class="i">$self</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$itemnum</span><span class="s">)</span><span class="i">-&gt;expiration_date</span><span class="s">(</span><span class="i">$expires</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$self</span>-&gt;{<span class="w">_item</span>}[ <span class="i">$itemnum</span> - <span class="n">1</span> ] = <span class="w">Christmas::Wishlist::WishItem</span><span class="i">-&gt;new</span><span class="s">(</span>
            <span class="w">for</span>         <span class="cm">=&gt;</span> <span class="i">$self</span>-&gt;{<span class="w">_userid</span>}<span class="cm">,</span>
            <span class="w">by</span>          <span class="cm">=&gt;</span> <span class="i">$author</span><span class="cm">,</span>
            <span class="w">requested</span>   <span class="cm">=&gt;</span> <span class="i">$num</span><span class="cm">,</span>
            <span class="w">description</span> <span class="cm">=&gt;</span> <span class="i">$descrip</span><span class="cm">,</span>
            <span class="w">ident</span>       <span class="cm">=&gt;</span> <span class="i">$itemnum</span><span class="cm">,</span>
            <span class="w">expires</span>     <span class="cm">=&gt;</span> <span class="i">$expires</span><span class="cm">,</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">_last_update</span>} = <span class="i">$update_time</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># _tranlog</span>
<span class="c"># Creates a properly formatted transaction line to the log for this transaction</span>

<a name="_tranlog-"></a><span class="k">sub </span><span class="m">_tranlog</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">%args</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="i">$args</span>{<span class="w">expires</span>} ||= <span class="q">&quot; &quot;</span><span class="sc">;</span>

    <span class="k">return</span> <span class="k">join</span> <span class="s">(</span>
        <span class="q">&quot;\t&quot;</span><span class="cm">,</span>
        <span class="s">(</span>
            <span class="k">scalar</span> <span class="k">localtime</span><span class="cm">,</span> <span class="i">$args</span>{<span class="w">by</span>}<span class="cm">,</span>          <span class="i">$args</span>{<span class="w">transcode</span>}<span class="cm">,</span>
            <span class="i">$args</span>{<span class="w">itemnum</span>}<span class="cm">,</span>   <span class="i">$args</span>{<span class="w">description</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">how_many</span>}<span class="cm">,</span>
            <span class="i">$args</span>{<span class="w">expires</span>}<span class="cm">,</span>
        <span class="s">)</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># _print_log </span>
<span class="c">#</span>
<a name="_print_log-"></a><span class="k">sub </span><span class="m">_print_log</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">%args</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$string</span> = <span class="i">_tranlog</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">NEWTRANS</span> <span class="q">&quot;$string\n&quot;</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<a name="remove-"></a><span class="k">sub </span><span class="m">remove</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">%args</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="i">$self</span><span class="i">-&gt;_delete</span><span class="s">(</span> <span class="i">$args</span>{<span class="w">itemnum</span>}<span class="cm">,</span> <span class="k">time</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$args</span>{<span class="w">transcode</span>} = <span class="q">&quot;delete&quot;</span><span class="sc">;</span>
    <span class="i">_print_log</span><span class="s">(</span>
        <span class="w">by</span>          <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">by</span>}<span class="cm">,</span>
        <span class="w">transcode</span>   <span class="cm">=&gt;</span> <span class="q">&quot;delete&quot;</span><span class="cm">,</span>
        <span class="w">itemnum</span>     <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">itemnum</span>}<span class="cm">,</span>
        <span class="w">description</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">description</span>}<span class="cm">,</span>
        <span class="w">how_many</span>    <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">how_many</span>}<span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c"># _delete - removes a deleted item from the wishlist object</span>
<span class="c"># Both part of the 'read&quot; subsystem that deals with an existing wishlist, and</span>
<span class="c"># the subsystem that processes new requests.</span>

<a name="_delete-"></a><span class="k">sub </span><span class="m">_delete</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">$itemnumber</span><span class="cm">,</span> <span class="i">$update_time</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># Note that the item index is 1 less than the item number</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$self</span>-&gt;{<span class="q">&quot;_item&quot;</span>}[ <span class="i">$itemnumber</span> - <span class="n">1</span> ] <span class="s">)</span><span class="sc">;</span>

    <span class="i">$self</span>-&gt;{<span class="q">&quot;_item&quot;</span>}[ <span class="i">$itemnumber</span> - <span class="n">1</span> ]<span class="i">-&gt;deleted</span><span class="s">(</span><span class="n">1</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="q">&quot;_last_update&quot;</span>} = <span class="i">$update_time</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># purchase - updates item and writes transaction log</span>
<span class="c">#            need to add record of who purchased</span>
<span class="c"># Args: Hash with element keys:</span>
<span class="c">#    itemnum</span>
<span class="c">#    description</span>
<span class="c">#    by</span>
<span class="c">#    how_many</span>

<a name="purchase-"></a><span class="k">sub </span><span class="m">purchase</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">%args</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">return</span>
      <span class="k">unless</span> <span class="i">$args</span>{<span class="w">itemnum</span>}
      <span class="k">and</span> <span class="k">defined</span> <span class="i">$args</span>{<span class="w">description</span>}
      <span class="k">and</span> <span class="i">$args</span>{<span class="w">by</span>}
      <span class="k">and</span> <span class="i">$args</span>{<span class="w">how_many</span>}<span class="sc">;</span>

    <span class="k">return</span>
      <span class="k">if</span> <span class="s">(</span>
        !<span class="i">$self</span><span class="i">-&gt;_bought</span><span class="s">(</span>
            <span class="i">$args</span>{<span class="w">itemnum</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">description</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">how_many</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">by</span>}
        <span class="s">)</span>
      <span class="s">)</span><span class="sc">;</span>

    <span class="i">_print_log</span><span class="s">(</span>
        <span class="w">by</span>          <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">by</span>}<span class="cm">,</span>
        <span class="w">transcode</span>   <span class="cm">=&gt;</span> <span class="q">&quot;bought&quot;</span><span class="cm">,</span>
        <span class="w">itemnum</span>     <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">itemnum</span>}<span class="cm">,</span>
        <span class="w">description</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">description</span>}<span class="cm">,</span>
        <span class="w">how_many</span>    <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">how_many</span>}<span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<a name="_bought-"></a><span class="k">sub </span><span class="m">_bought</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">$itemnum</span><span class="cm">,</span> <span class="i">$descrip</span><span class="cm">,</span> <span class="i">$num</span><span class="cm">,</span> <span class="i">$by</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$item</span> = <span class="i">$self</span><span class="i">-&gt;item</span><span class="s">(</span><span class="i">$itemnum</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$item</span><span class="i">-&gt;buy</span><span class="s">(</span> <span class="i">$num</span><span class="cm">,</span> <span class="i">$descrip</span><span class="cm">,</span> <span class="i">$by</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<span class="c"># suggest_update</span>
<span class="c"># Creates or modifies a suggestion and writes it out to the transaction log</span>
<a name="suggest_update-"></a><span class="k">sub </span><span class="m">suggest_update</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">%args</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">return</span> <span class="k">unless</span> <span class="i">$args</span>{<span class="w">by</span>} <span class="k">and</span> <span class="i">$args</span>{<span class="w">requested</span>} <span class="k">and</span> <span class="i">$args</span>{<span class="w">description</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">itemnum</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;_update</span><span class="s">(</span>
            <span class="i">$args</span>{<span class="w">itemnum</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">description</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">requested</span>}<span class="cm">,</span>
            <span class="i">$args</span>{<span class="w">by</span>}<span class="cm">,</span>      <span class="i">$args</span>{<span class="w">expires</span>}<span class="cm">,</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">delete</span> <span class="i">$args</span>{<span class="w">itemnum</span>}<span class="sc">;</span>    <span class="c"># In case it exists but is undefined.</span>
            <span class="c"># Should probably pass the arguments explicitely, rather than</span>
            <span class="c"># pulling things like the previous line.</span>

        <span class="k">my</span> <span class="i">$newitemindex</span> = <span class="i">$#</span>{ <span class="i">$self</span>-&gt;{<span class="w">_item</span>} } + <span class="n">1</span><span class="sc">;</span>

        <span class="c">#        $args{for}   = $self-&gt;{_userid};</span>
        <span class="c">#        $args{ident} = $newitemindex + 1;</span>
        <span class="k">my</span> <span class="i">$newitem</span> = <span class="w">Christmas::Wishlist::WishItem</span><span class="i">-&gt;new</span><span class="s">(</span>
            <span class="i">%args</span><span class="cm">,</span>
            <span class="w">for</span>   <span class="cm">=&gt;</span> <span class="i">$self</span>-&gt;{<span class="w">_userid</span>}<span class="cm">,</span>
            <span class="w">ident</span> <span class="cm">=&gt;</span> <span class="i">$newitemindex</span> + <span class="n">1</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">_item</span>}[<span class="i">$newitemindex</span>] = <span class="i">$newitem</span><span class="sc">;</span>
        <span class="i">$args</span>{<span class="w">itemnum</span>} = <span class="i">$newitemindex</span> + <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">_print_log</span><span class="s">(</span>
        <span class="w">by</span>          <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">by</span>}<span class="cm">,</span>
        <span class="w">transcode</span>   <span class="cm">=&gt;</span> <span class="q">&quot;added&quot;</span><span class="cm">,</span>
        <span class="w">itemnum</span>     <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">itemnum</span>}<span class="cm">,</span>
        <span class="w">description</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">description</span>}<span class="cm">,</span>
        <span class="w">how_many</span>    <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">requested</span>}<span class="cm">,</span>
        <span class="w">expires</span>     <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">expires</span>}<span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$args</span>{<span class="w">itemnum</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<a name="userid-"></a><span class="k">sub </span><span class="m">userid</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$self</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span>-&gt;{<span class="w">_userid</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<a name="item-"></a><span class="k">sub </span><span class="m">item</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">$num</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># The item index is 1 less than the item number</span>
    <span class="k">return</span> <span class="i">$self</span>-&gt;{<span class="w">_item</span>}[ <span class="i">$num</span> - <span class="n">1</span> ]<span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<a name="last_update-"></a><span class="k">sub </span><span class="m">last_update</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$self</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span>-&gt;{<span class="w">_last_update</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<a name="get_items-"></a><span class="k">sub </span><span class="m">get_items</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">@</span>{ <span class="i">$self</span>-&gt;{<span class="w">_item</span>} }<span class="sc">;</span>
<span class="s">}</span>

<span class="c">#_____________________________________________________________________________</span>
<span class="c">#</span>
<a name="_unindent-"></a><span class="k">sub </span><span class="m">_unindent</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$string</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$string</span> =~ <span class="q">s/^\s+//gm</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$string</span><span class="sc">;</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<span class="c">#_____________________________________________________________________________</span>

<a name="__END__-"></a><span class="k">__END__</span>

</pre><pre><a name="EOF-"></a></pre>    </BODY>

    </HTML>
